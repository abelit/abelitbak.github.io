import{_ as e}from"./plugin-vue_export-helper-DlAUqK2U.js";import{o as a,c as s,f as n}from"./app-DR5J2daJ.js";const l={},i=n(`<h2 id="基本流程" tabindex="-1"><a class="header-anchor" href="#基本流程"><span>基本流程</span></a></h2><ol><li>升级主控制平面节点</li><li>升级其他控制平面节点</li><li>升级工作节点</li></ol><h2 id="确定版本" tabindex="-1"><a class="header-anchor" href="#确定版本"><span>确定版本</span></a></h2><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum list <span class="token parameter variable">--showduplicates</span> kubeadm <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="升级控制平面节点" tabindex="-1"><a class="header-anchor" href="#升级控制平面节点"><span>升级控制平面节点</span></a></h2><p>控制面节点上的升级过程应该每次处理一个节点。 首先选择一个要先行升级的控制面节点。该节点上必须拥有 /etc/kubernetes/admin.conf 文件。</p><h3 id="对于第一个控制面节点" tabindex="-1"><a class="header-anchor" href="#对于第一个控制面节点"><span>对于第一个控制面节点</span></a></h3><h4 id="升级-kubeadm" tabindex="-1"><a class="header-anchor" href="#升级-kubeadm"><span>升级 kubeadm</span></a></h4><ul><li>安装kubeadm</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubeadm-1.26.4-0 <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>版本升级 v1.26.3 &gt; v1.26.4</p></blockquote><ul><li>验证下载操作正常，并且 kubeadm 版本正确：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>kubeadm version
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>验证升级计划：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>kubeadm upgrade plan
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>此命令检查你的集群是否可被升级，并取回你要升级的目标版本。 命令也会显示一个包含组件配置版本状态的表格。</p></blockquote><ul><li>选择要升级到的目标版本，运行合适的命令</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>kubeadm upgrade apply v1.26.4
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>手动升级你的 CNI 驱动插件 <blockquote><p>如果 CNI 驱动作为 DaemonSet 运行，则在其他控制平面节点上不需要此步骤。</p></blockquote></li></ul><h4 id="腾空节点" tabindex="-1"><a class="header-anchor" href="#腾空节点"><span>腾空节点</span></a></h4><ul><li>将节点标记为不可调度并驱逐所有负载，准备节点的维护：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 将 &lt;node-to-drain&gt; 替换为你要腾空的控制面节点名称</span>
<span class="token comment"># kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets</span>
kubectl drain k8s-master01 --ignore-daemonsets

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="升级-kubelet-和-kubectl" tabindex="-1"><a class="header-anchor" href="#升级-kubelet-和-kubectl"><span>升级 kubelet 和 kubectl</span></a></h4><ul><li>安装 kubelet 和 kubectl</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet-1.26.4-0 kubectl-1.26.4-0 <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>重启 kubelet：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="解除节点的保护" tabindex="-1"><a class="header-anchor" href="#解除节点的保护"><span>解除节点的保护</span></a></h4><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 将 &lt;node-to-uncordon&gt; 替换为你的节点名称</span>
<span class="token comment"># kubectl uncordon &lt;node-to-uncordon&gt;</span>
kubectl uncordon k8s-master01
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="对于其它控制面节点" tabindex="-1"><a class="header-anchor" href="#对于其它控制面节点"><span>对于其它控制面节点</span></a></h3><h4 id="升级-kubeadm-1" tabindex="-1"><a class="header-anchor" href="#升级-kubeadm-1"><span>升级 kubeadm</span></a></h4><ul><li>安装 kubeadm：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubeadm-1.26.4-0 <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>更新控制平面节点信息</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> kubeadm upgrade <span class="token function">node</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>不需要执行 kubeadm upgrade plan 和更新 CNI 驱动插件的操作。</p></blockquote><h4 id="腾空节点-1" tabindex="-1"><a class="header-anchor" href="#腾空节点-1"><span>腾空节点</span></a></h4><ul><li>将节点标记为不可调度并驱逐所有负载，准备节点的维护：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 将 &lt;node-to-drain&gt; 替换为你要腾空的控制面节点名称</span>
<span class="token comment"># kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets</span>
kubectl drain k8s-master02 --ignore-daemonsets

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="升级-kubelet-和-kubectl-1" tabindex="-1"><a class="header-anchor" href="#升级-kubelet-和-kubectl-1"><span>升级 kubelet 和 kubectl</span></a></h4><ul><li>升级 kubelet 和 kubectl</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet-1.26.4-0 kubectl-1.26.4-0 <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>重启 kubelet：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="解除节点的保护-1" tabindex="-1"><a class="header-anchor" href="#解除节点的保护-1"><span>解除节点的保护</span></a></h4><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 将 &lt;node-to-uncordon&gt; 替换为你的节点名称</span>
<span class="token comment"># kubectl uncordon &lt;node-to-uncordon&gt;</span>
kubectl uncordon k8s-master02
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="升级工作节点" tabindex="-1"><a class="header-anchor" href="#升级工作节点"><span>升级工作节点</span></a></h2><p>工作节点上的升级过程应该一次执行一个节点，或者一次执行几个节点， 以不影响运行工作负载所需的最小容量。</p><h3 id="升级-kubeadm-2" tabindex="-1"><a class="header-anchor" href="#升级-kubeadm-2"><span>升级 kubeadm</span></a></h3><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubeadm-1.26.4-0 <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="执行-kubeadm-upgrade" tabindex="-1"><a class="header-anchor" href="#执行-kubeadm-upgrade"><span>执行 &quot;kubeadm upgrade&quot;</span></a></h3><ul><li>对于工作节点，下面的命令会升级本地的 kubelet 配置</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> kubeadm upgrade <span class="token function">node</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="腾空节点-2" tabindex="-1"><a class="header-anchor" href="#腾空节点-2"><span>腾空节点</span></a></h3><ul><li>将节点标记为不可调度并驱逐所有负载，准备节点的维护：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 将 &lt;node-to-drain&gt; 替换为你正腾空的节点的名称</span>
<span class="token comment"># kubectl drain &lt;node-to-drain&gt; --ignore-daemonsets</span>
kubectl drain k8s-worker01 --ignore-daemonsets
kubectl drain k8s-worker02 --ignore-daemonsets
kubectl drain k8s-worker03 --ignore-daemonsets
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="升级-kubelet-和-kubectl-2" tabindex="-1"><a class="header-anchor" href="#升级-kubelet-和-kubectl-2"><span>升级 kubelet 和 kubectl</span></a></h3><ul><li>升级 kubelet 和 kubectl:</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet-1.26.4-0 kubectl-1.26.4-0 <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>重启 kubelet：</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart kubelet
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="解除节点的保护-2" tabindex="-1"><a class="header-anchor" href="#解除节点的保护-2"><span>解除节点的保护</span></a></h3><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 将 &lt;node-to-uncordon&gt; 替换为你的节点名称</span>
<span class="token comment"># kubectl uncordon &lt;node-to-uncordon&gt;</span>
kubectl uncordon k8s-worker01
kubectl uncordon k8s-worker02
kubectl uncordon k8s-worker03
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="验证集群的状态" tabindex="-1"><a class="header-anchor" href="#验证集群的状态"><span>验证集群的状态</span></a></h2><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>kubectl get nodes
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,65),t=[i];function d(r,c){return a(),s("div",null,t)}const b=e(l,[["render",d],["__file","upgrade-k8s.html.vue"]]),p=JSON.parse('{"path":"/guide/cloudnative/kubernetes/installation/upgrade-k8s.html","title":"Kubernetes集群升级","lang":"zh-CN","frontmatter":{"title":"Kubernetes集群升级","description":"基本流程 升级主控制平面节点 升级其他控制平面节点 升级工作节点 确定版本 升级控制平面节点 控制面节点上的升级过程应该每次处理一个节点。 首先选择一个要先行升级的控制面节点。该节点上必须拥有 /etc/kubernetes/admin.conf 文件。 对于第一个控制面节点 升级 kubeadm 安装kubeadm 版本升级 v1.26.3 > v1...","head":[["meta",{"property":"og:url","content":"https://github.com/abelit/abelit-datapeacock.git/guide/cloudnative/kubernetes/installation/upgrade-k8s.html"}],["meta",{"property":"og:site_name","content":"数之雀"}],["meta",{"property":"og:title","content":"Kubernetes集群升级"}],["meta",{"property":"og:description","content":"基本流程 升级主控制平面节点 升级其他控制平面节点 升级工作节点 确定版本 升级控制平面节点 控制面节点上的升级过程应该每次处理一个节点。 首先选择一个要先行升级的控制面节点。该节点上必须拥有 /etc/kubernetes/admin.conf 文件。 对于第一个控制面节点 升级 kubeadm 安装kubeadm 版本升级 v1.26.3 > v1..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-11T14:06:18.000Z"}],["meta",{"property":"article:author","content":"Abelit"}],["meta",{"property":"article:modified_time","content":"2024-05-11T14:06:18.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Kubernetes集群升级\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-05-11T14:06:18.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Abelit\\",\\"url\\":\\"https://github.com/abelit\\"}]}"]]},"headers":[{"level":2,"title":"基本流程","slug":"基本流程","link":"#基本流程","children":[]},{"level":2,"title":"确定版本","slug":"确定版本","link":"#确定版本","children":[]},{"level":2,"title":"升级控制平面节点","slug":"升级控制平面节点","link":"#升级控制平面节点","children":[{"level":3,"title":"对于第一个控制面节点","slug":"对于第一个控制面节点","link":"#对于第一个控制面节点","children":[]},{"level":3,"title":"对于其它控制面节点","slug":"对于其它控制面节点","link":"#对于其它控制面节点","children":[]}]},{"level":2,"title":"升级工作节点","slug":"升级工作节点","link":"#升级工作节点","children":[{"level":3,"title":"升级 kubeadm","slug":"升级-kubeadm-2","link":"#升级-kubeadm-2","children":[]},{"level":3,"title":"执行 \\"kubeadm upgrade\\"","slug":"执行-kubeadm-upgrade","link":"#执行-kubeadm-upgrade","children":[]},{"level":3,"title":"腾空节点","slug":"腾空节点-2","link":"#腾空节点-2","children":[]},{"level":3,"title":"升级 kubelet 和 kubectl","slug":"升级-kubelet-和-kubectl-2","link":"#升级-kubelet-和-kubectl-2","children":[]},{"level":3,"title":"解除节点的保护","slug":"解除节点的保护-2","link":"#解除节点的保护-2","children":[]}]},{"level":2,"title":"验证集群的状态","slug":"验证集群的状态","link":"#验证集群的状态","children":[]}],"git":{"createdTime":1715436378000,"updatedTime":1715436378000,"contributors":[{"name":"ableit","email":"ychenid@live.com","commits":1}]},"readingTime":{"minutes":2.77,"words":830},"filePathRelative":"guide/cloudnative/kubernetes/installation/upgrade-k8s.md","localizedDate":"2024年5月11日","autoDesc":true,"excerpt":"<h2>基本流程</h2>\\n<ol>\\n<li>升级主控制平面节点</li>\\n<li>升级其他控制平面节点</li>\\n<li>升级工作节点</li>\\n</ol>\\n<h2>确定版本</h2>\\n<div class=\\"language-bash\\" data-ext=\\"sh\\" data-title=\\"sh\\"><pre class=\\"language-bash\\"><code>yum list <span class=\\"token parameter variable\\">--showduplicates</span> kubeadm <span class=\\"token parameter variable\\">--disableexcludes</span><span class=\\"token operator\\">=</span>kubernetes\\n</code></pre></div>"}');export{b as comp,p as data};
