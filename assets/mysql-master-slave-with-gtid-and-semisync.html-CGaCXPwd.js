import{_ as p}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as d,o as c,c as r,b as i,w as a,f as o,a as s,d as n}from"./app-DR5J2daJ.js";const u={},m=o(`<h2 id="主从同步-gtid-半同步模式" tabindex="-1"><a class="header-anchor" href="#主从同步-gtid-半同步模式"><span>主从同步（GTID+半同步模式）</span></a></h2><h3 id="主机信息" tabindex="-1"><a class="header-anchor" href="#主机信息"><span>主机信息</span></a></h3><table><thead><tr><th>编号</th><th>IP 地址</th><th>角色</th><th>操作系统</th><th>内核版本</th><th>数据库版本</th></tr></thead><tbody><tr><td>1</td><td>10.10.12.213</td><td>主</td><td>CentOS 7.9</td><td>3.10.0-1160.el7.x86_64</td><td>MySQL 8.0</td></tr><tr><td>2</td><td>10.10.12.214</td><td>从</td><td>CentOS 7.9</td><td>3.10.0-1160.el7.x86_64</td><td>MySQL 8.0</td></tr></tbody></table><h3 id="安装数据库" tabindex="-1"><a class="header-anchor" href="#安装数据库"><span>安装数据库</span></a></h3><ul><li>安装 <blockquote><p>主、从</p></blockquote></li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>systemctl stop firewalld
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> https://repo.mysql.com//mysql80-community-release-el7-7.noarch.rpm
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> mysql-server
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>重启数据库 <blockquote><p>主从节点</p></blockquote></li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>systemctl restart mysqld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>获取初始化密码</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">cat</span> /var/log/mysqld.log<span class="token operator">|</span><span class="token function">grep</span> <span class="token string">&quot;A temporary password&quot;</span><span class="token operator">|</span><span class="token function">awk</span> -F<span class="token string">&#39;root@localhost:&#39;</span> <span class="token string">&#39;{print $2}&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>更改密码</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">user</span> root<span class="token variable">@localhost</span> identified <span class="token keyword">by</span> <span class="token string">&quot;Hello@2023&quot;</span><span class="token punctuation">;</span>
flush <span class="token keyword">privileges</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="安装半同步复制插件" tabindex="-1"><a class="header-anchor" href="#安装半同步复制插件"><span>安装半同步复制插件</span></a></h3><ul><li>查看是否支持动态插件 <blockquote><p>主、从</p></blockquote></li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> @<span class="token variable">@have_dynamic_loading</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>主库安装插件</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>install plugin rpl_semi_sync_master <span class="token keyword">soname</span> <span class="token string">&#39;semisync_master.so&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>主库启用半同步复制</li></ul>`,18),v=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"set"),n(" persist rpl_semi_sync_master_enabled"),s("span",{class:"token operator"},"="),s("span",{class:"token number"},"1"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),k=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"set"),n(),s("span",{class:"token keyword"},"global"),n(" rpl_semi_sync_master_enabled"),s("span",{class:"token operator"},"="),s("span",{class:"token number"},"1"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),b=o(`<ul><li>从库安装插件</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>install plugin rpl_semi_sync_slave <span class="token keyword">soname</span> <span class="token string">&#39;semisync_slave.so&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>从库启用半同步复制</li></ul>`,3),g=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"set"),n(" persist rpl_semi_sync_slave_enabled"),s("span",{class:"token operator"},"="),s("span",{class:"token number"},"1"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),h=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"set"),n(),s("span",{class:"token keyword"},"global"),n(" rpl_semi_sync_slave_enabled"),s("span",{class:"token operator"},"="),s("span",{class:"token number"},"1"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),_=s("ul",null,[s("li",null,"查看已安装插件")],-1),y=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"show"),n(" PLUGINS"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),q=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"SELECT"),n(" plugin_name"),s("span",{class:"token punctuation"},","),n(" plugin_status "),s("span",{class:"token keyword"},"from"),n(" information_schema"),s("span",{class:"token punctuation"},"."),n("PLUGINS "),s("span",{class:"token keyword"},"where"),n(" plugin_name "),s("span",{class:"token operator"},"like"),n(),s("span",{class:"token string"},"'%semi%'"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),w=o(`<ul><li>重启 IO 线程</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>stop slave io_thread<span class="token punctuation">;</span>
<span class="token keyword">start</span> slave io_thread<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="配置主从数据库" tabindex="-1"><a class="header-anchor" href="#配置主从数据库"><span>配置主从数据库</span></a></h3><h4 id="主节点" tabindex="-1"><a class="header-anchor" href="#主节点"><span><strong>主节点</strong></span></a></h4><ul><li>配置文件</li></ul><div class="language-conf line-numbers-mode" data-ext="conf" data-title="conf"><pre class="language-conf"><code>[mysqld]
server-id=1
log-bin=mysql-bin
binlog_expire_logs_seconds=2592000
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
rpl_semi_sync_master_enabled = 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="从节点" tabindex="-1"><a class="header-anchor" href="#从节点"><span><strong>从节点</strong></span></a></h4><ul><li>配置文件</li></ul><div class="language-conf line-numbers-mode" data-ext="conf" data-title="conf"><pre class="language-conf"><code>[mysqld]
server-id=2
log-bin=mysql-bin
binlog_expire_logs_seconds=2592000
binlog_format=row
gtid-mode=on
enforce-gtid-consistency=true
log-slave-updates=1
rpl_semi_sync_slave_enabled = 1
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>参数说明</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token comment"># 设置 server-id,唯一值，标识主机，必须与从库不一致</span>
server-id<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment"># 开启二进制日志，主库必须开启</span>
log-bin<span class="token operator">=</span>mysql-bin
<span class="token comment"># 自动删除 2592000 秒（30 天）前的日志</span>
<span class="token comment"># 8.0 以前的版本中这个配置为 expire_logs_days，单位为天</span>
<span class="token assign-left variable">binlog_expire_logs_seconds</span><span class="token operator">=</span><span class="token number">2592000</span>
<span class="token comment"># binlog 记录的模式</span>
<span class="token comment"># statement 模式不会记录每一条更改语句，节约资源但主从数据可能不一致</span>
<span class="token comment"># row 模式记录每一条更改的语句，日志量非常大</span>
<span class="token comment"># mixed 模式是前两者优点的综合，但日志结构较为复杂</span>
<span class="token assign-left variable">binlog_format</span><span class="token operator">=</span>row
<span class="token comment">#启用gitd功能</span>
gtid-mode<span class="token operator">=</span>on
<span class="token comment">#开启强制GTID一致性</span>
enforce-gtid-consistency<span class="token operator">=</span>true
<span class="token comment"># 记录IO线程读取已经读取到的master binlog位置，用于slave宕机后IO线程根据文件中的POS点重新拉取binlog日志</span>
master-info-repository <span class="token operator">=</span> TABLE
<span class="token comment">#记录SQL线程读取Master binlog的位置，用于Slave 宕机后根据文件中记录的pos点恢复Sql线程</span>
relay-log-info-repository <span class="token operator">=</span> TABLE
<span class="token comment">#启用确保无信息丢失；任何一个事务提交后, 将二进制日志的文件名及事件位置记录到文件中</span>
sync-master-info <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#设定从服务器的复制线程数；0表示关闭多线程复制功能</span>
slave-parallel-workers <span class="token operator">=</span> <span class="token number">2</span>
<span class="token comment">#设置binlog校验算法（循环冗余校验码）</span>
binlog-checksum <span class="token operator">=</span> CRC32
<span class="token comment">#设置主服务器是否校验</span>
master-verify-checksum <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#设置从服务器是否校验</span>
slave-sql-verify-checksum <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#用于在二进制日志记录事件相关的信息，可降低故障排除的复杂度</span>
binlog-rows-query-log_events <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#保证master crash safe，该参数必须设置为1</span>
sync_binlog <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#保证master crash safe，该参数必须设置为1</span>
innodb_flush_log_at_trx_commit <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment"># 释义：slave更新是否记入binlog日志，方便数据恢复后从库进行全备，切换主从身份，这里打开即可</span>
log-slave-updates<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#表示主库开启半同步复制</span>
rpl_semi_sync_master_enabled <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">#表示从库开启半同步复制</span>
<span class="token assign-left variable">rpl_semi_sync_slave_enabled</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>重启数据库 <blockquote><p>主从节点</p></blockquote></li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>systemctl restart mysqld
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="传输基础数据" tabindex="-1"><a class="header-anchor" href="#传输基础数据"><span>传输基础数据</span></a></h3><ul><li>写入测试数据 <blockquote><p>主节点</p></blockquote></li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> abelitdb <span class="token keyword">CHARSET</span> utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">USE</span> abelitdb<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> abelitinfo <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">&quot;主键&quot;</span><span class="token punctuation">,</span>
    name <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">&quot;姓名&quot;</span><span class="token punctuation">,</span>
    <span class="token keyword">INDEX</span> idx_name<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">&quot;普通索引&quot;</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token keyword">innodb</span> <span class="token keyword">CHARSET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> abelitinfo<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;Tom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">&quot;Mary&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> abelitinfo<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>导出数据 <blockquote><p>主节点</p></blockquote></li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>mysqldump <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> --skip-lock-tables --single-transaction --flush-logs --hex-blob --master-data<span class="token operator">=</span><span class="token number">2</span> --all-databases <span class="token operator">&gt;</span> alldatabases.sql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">参数说明</p><p>--skip-lock-tables #不锁表</p><p>--single-transaction #设定事务级别为可重复读</p><p>--flush-logs #开启一个新的 binlog 文件</p><p>--hex-blob #以 16 进制导出 blob 数据</p><p>--master-data=2 #导出数据库时将 binlog 信息也一并导出，2 表示注释 binlog 信息</p></div><ul><li>传输数据到从库 <blockquote><p>主节点</p></blockquote></li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">scp</span> alldatabases.sql root@10.10.12.214:/root/
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>在从库上还原数据 <blockquote><p>从节点</p></blockquote></li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> <span class="token operator">&lt;</span> alldatabases.sql
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="创建复制用户" tabindex="-1"><a class="header-anchor" href="#创建复制用户"><span>创建复制用户</span></a></h3><ul><li>主节点</li></ul><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>create user <span class="token string">&#39;repl&#39;</span>@<span class="token string">&#39;%&#39;</span> identified by <span class="token string">&#39;Hello@2022&#39;</span><span class="token punctuation">;</span>
grant replication slave,replication client on *.* to <span class="token string">&#39;repl&#39;</span>@<span class="token string">&#39;%&#39;</span><span class="token punctuation">;</span>
flush privileges<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="设置从库" tabindex="-1"><a class="header-anchor" href="#设置从库"><span>设置从库</span></a></h3><ul><li>配置从库连接主库信息</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>change master <span class="token keyword">to</span>
    master_host<span class="token operator">=</span><span class="token string">&#39;10.10.12.213&#39;</span><span class="token punctuation">,</span>
    master_port<span class="token operator">=</span><span class="token number">3306</span><span class="token punctuation">,</span>
    master_user<span class="token operator">=</span><span class="token string">&#39;repl&#39;</span><span class="token punctuation">,</span>
    master_password<span class="token operator">=</span><span class="token string">&#39;Hello@2022&#39;</span><span class="token punctuation">,</span>
    master_connect_retry<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
    master_auto_position<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container tip"><p class="hint-container-title">参数说明</p><p>MASTER_HOST：主库的地址</p><p>MASTER_PORT：主库端口号</p><p>MASTER_USER：主库中用于复制的用户</p><p>MASTER_PASSWORD：主库中用于复制的用户密码</p><p>MASTER_CONNECT_RETRY：主库链接失败后从库重试链接的次数</p><p>MASTER_AUTO_POSITION：是否自动寻找 MASTER 中的 GTID 号位置，详情参见外面的描述 首先我们是使用的 mysqldump 对主库进行全备，并在从库上进行了恢复。 那么全备的 sql 文件中就会存在已截取的 GTID 事务号。</p><p>MASTER_AUTO_POSITION=1 实际上是让从库从主库 GTID 事务号 1 后开始截取，如果是 mysqldump 进行逻辑备份恢复则会自动将该参数调整为全备 SQL 文件中的 GTID 事务号+1。</p><p>那么如果是 XBK 物理备份怎么填写该参数呢？你需要 xtrabackup_binlog_info 文件中，读取出已截取的 GTID 事务号，填写时+1 即可（只截取最后的那个数字！不是整个 uuid+int 的字符串）。</p><p>总结！mysqldump 逻辑备份恢复，该参数填 1，内部会自动进行校正。 XBK 物理备份恢复，检查 xtrabackup_binlog_info 文件，该参数在 GTID 事务号基础上+1</p></div><ul><li>开启从库</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">start</span> slave<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="查看主从状态" tabindex="-1"><a class="header-anchor" href="#查看主从状态"><span>查看主从状态</span></a></h3><ul><li>检查从库状态</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">show</span> slave <span class="token keyword">status</span>\\G
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">注意事项：</p><p>当 Slave_IO_Running 和 Slave_SQL_Running 都为 Yes 的时候，表示主从同步正常。</p></div><ul><li>检查半同步状态是否可用</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">global</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">&#39;rpl_semi_sync%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>状态参数说明</li></ul><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>rpl_semi_sync_master_status   主库半同步复制状态是否启用
rpl_semi_sync_slave_status  从库半同步复制状态是否启用
rpl_semi_sync_master_clients   记录支持半同步的slave的个数
rpl_semi_sync_master_yes_tx   master成功接收到slave的回复的次数
rpl_semi_sync_master_no_tx   master没有收到slave的回复而提交的次数， 0  #如果不为0 说明使用传统异步复制到slave，不代表不正常如果持续时间久 检查网络原因
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>环境变量查询</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">&quot;rpl_semi_sync%&quot;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>环境变量参数说明</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>rpl_semi_sync_master_enabled<span class="token operator">=</span><span class="token keyword">ON</span>  表示开启半同步复制
rpl_semi_sync_master_timeout<span class="token operator">=</span><span class="token number">10000</span>  单位为毫秒，即<span class="token number">10</span>秒超时，将切换为异步复制
rpl_semi_sync_master_trace_level<span class="token operator">=</span><span class="token number">32</span>  表示用于开启半同步复制时的调试级别，默认<span class="token number">32</span>
rpl_semi_sync_master_wait_point<span class="token operator">=</span>AFTER_SYNC  ACK确认点位；AFTER_SYNC : 收到ACK 时候才会<span class="token keyword">commit</span>，然后返回给客户端；AFTER_COMMIT: 先<span class="token keyword">commit</span> 收到ACK 时候，才返回给客户端；默认AFTER_SYNC<span class="token punctuation">,</span>
rpl_semi_sync_master_wait_no_slave<span class="token operator">=</span><span class="token keyword">ON</span>  表示是否允许master每个事务都要等待slave接收确认。默认为<span class="token keyword">ON</span>，每一个事务都会等待，如果slave crash后，当slave追赶上master的日志时，可以自动的切换为半同步方式。如果为<span class="token keyword">OFF</span><span class="token punctuation">,</span>则slave追赶上后，也不会采用半同步的方式复制了，需要手工配置。如果主从一致性要求高： rpl_semi_sync_master_wait_no_slave <span class="token operator">=</span><span class="token keyword">on</span>  <span class="token operator">&amp;</span> 调大 rpl_semi_sync_master_timeout；如果主从一致性要求不高： rpl_semi_sync_master_wait_no_slave <span class="token operator">=</span><span class="token keyword">off</span> <span class="token operator">&amp;</span> 调大 rpl_semi_sync_master_timeout
rpl_semi_sync_master_wait_for_slave_count<span class="token operator">=</span><span class="token number">1</span>  MySQL <span class="token number">5.7</span><span class="token number">.3</span>引入的，该变量设置主库需要等待多少个slave应答，才能返回给客户端，默认为<span class="token number">1</span>。
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>测试</li></ul><p>主库写入数据</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">use</span> abelitdb<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> abelitinfo<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&quot;abelit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> abelitinfo<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从库查看数据是否同步</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">use</span> abelitdb<span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> abelitinfo<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">&quot;abelit&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> abelitinfo<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="常见问题" tabindex="-1"><a class="header-anchor" href="#常见问题"><span>常见问题</span></a></h3><p>Q1:</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>如果报错 ibimf.so: cannot open shared object file:, No such file or directory
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>A1:</p><div class="language-text line-numbers-mode" data-ext="text" data-title="text"><pre class="language-text"><code>安装libimf
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div>`,54);function f(x,T){const t=d("CodeTabs");return c(),r("div",null,[m,i(t,{id:"148",data:[{id:"持久化配置"},{id:"全局配置"}],active:0},{title0:a(({value:e,isActive:l})=>[n("持久化配置")]),title1:a(({value:e,isActive:l})=>[n("全局配置")]),tab0:a(({value:e,isActive:l})=>[v]),tab1:a(({value:e,isActive:l})=>[k]),_:1}),b,i(t,{id:"171",data:[{id:"持久化配置"},{id:"全局配置"}],active:0},{title0:a(({value:e,isActive:l})=>[n("持久化配置")]),title1:a(({value:e,isActive:l})=>[n("全局配置")]),tab0:a(({value:e,isActive:l})=>[g]),tab1:a(({value:e,isActive:l})=>[h]),_:1}),_,i(t,{id:"186",data:[{id:"命令"},{id:"SQL"}],active:0},{title0:a(({value:e,isActive:l})=>[n("命令")]),title1:a(({value:e,isActive:l})=>[n("SQL")]),tab0:a(({value:e,isActive:l})=>[y]),tab1:a(({value:e,isActive:l})=>[q]),_:1}),w])}const E=p(u,[["render",f],["__file","mysql-master-slave-with-gtid-and-semisync.html.vue"]]),I=JSON.parse('{"path":"/guide/database/mysql/ha/deployment/mysql-master-slave-with-gtid-and-semisync.html","title":"MySQL主从复制（基于GTID半同步复制）","lang":"zh-CN","frontmatter":{"title":"MySQL主从复制（基于GTID半同步复制）","description":"主从同步（GTID+半同步模式） 主机信息 安装数据库 安装 主、从 重启数据库 主从节点 获取初始化密码 更改密码 安装半同步复制插件 查看是否支持动态插件 主、从 主库安装插件 主库启用半同步复制 从库安装插件 从库启用半同步复制 查看已安装插件 重启 IO 线程 配置主从数据库 主节点 配置文件 从节点 配置文件 参数说明 重启数据库 主从节点 ...","head":[["meta",{"property":"og:url","content":"https://github.com/abelit/abelit-datapeacock.git/guide/database/mysql/ha/deployment/mysql-master-slave-with-gtid-and-semisync.html"}],["meta",{"property":"og:site_name","content":"数之雀"}],["meta",{"property":"og:title","content":"MySQL主从复制（基于GTID半同步复制）"}],["meta",{"property":"og:description","content":"主从同步（GTID+半同步模式） 主机信息 安装数据库 安装 主、从 重启数据库 主从节点 获取初始化密码 更改密码 安装半同步复制插件 查看是否支持动态插件 主、从 主库安装插件 主库启用半同步复制 从库安装插件 从库启用半同步复制 查看已安装插件 重启 IO 线程 配置主从数据库 主节点 配置文件 从节点 配置文件 参数说明 重启数据库 主从节点 ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-11T14:06:18.000Z"}],["meta",{"property":"article:author","content":"Abelit"}],["meta",{"property":"article:modified_time","content":"2024-05-11T14:06:18.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MySQL主从复制（基于GTID半同步复制）\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-05-11T14:06:18.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Abelit\\",\\"url\\":\\"https://github.com/abelit\\"}]}"]]},"headers":[{"level":2,"title":"主从同步（GTID+半同步模式）","slug":"主从同步-gtid-半同步模式","link":"#主从同步-gtid-半同步模式","children":[{"level":3,"title":"主机信息","slug":"主机信息","link":"#主机信息","children":[]},{"level":3,"title":"安装数据库","slug":"安装数据库","link":"#安装数据库","children":[]},{"level":3,"title":"安装半同步复制插件","slug":"安装半同步复制插件","link":"#安装半同步复制插件","children":[]},{"level":3,"title":"配置主从数据库","slug":"配置主从数据库","link":"#配置主从数据库","children":[]},{"level":3,"title":"传输基础数据","slug":"传输基础数据","link":"#传输基础数据","children":[]},{"level":3,"title":"创建复制用户","slug":"创建复制用户","link":"#创建复制用户","children":[]},{"level":3,"title":"设置从库","slug":"设置从库","link":"#设置从库","children":[]},{"level":3,"title":"查看主从状态","slug":"查看主从状态","link":"#查看主从状态","children":[]},{"level":3,"title":"常见问题","slug":"常见问题","link":"#常见问题","children":[]}]}],"git":{"createdTime":1715436378000,"updatedTime":1715436378000,"contributors":[{"name":"ableit","email":"ychenid@live.com","commits":1}]},"readingTime":{"minutes":6.5,"words":1949},"filePathRelative":"guide/database/mysql/ha/deployment/mysql-master-slave-with-gtid-and-semisync.md","localizedDate":"2024年5月11日","autoDesc":true,"excerpt":"<h2>主从同步（GTID+半同步模式）</h2>\\n<h3>主机信息</h3>\\n<table>\\n<thead>\\n<tr>\\n<th>编号</th>\\n<th>IP 地址</th>\\n<th>角色</th>\\n<th>操作系统</th>\\n<th>内核版本</th>\\n<th>数据库版本</th>\\n</tr>\\n</thead>\\n<tbody>\\n<tr>\\n<td>1</td>\\n<td>10.10.12.213</td>\\n<td>主</td>\\n<td>CentOS 7.9</td>\\n<td>3.10.0-1160.el7.x86_64</td>\\n<td>MySQL 8.0</td>\\n</tr>\\n<tr>\\n<td>2</td>\\n<td>10.10.12.214</td>\\n<td>从</td>\\n<td>CentOS 7.9</td>\\n<td>3.10.0-1160.el7.x86_64</td>\\n<td>MySQL 8.0</td>\\n</tr>\\n</tbody>\\n</table>"}');export{E as comp,I as data};
