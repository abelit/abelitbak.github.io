import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as c,o as u,c as d,b as o,w as a,f as p,a as s,d as n}from"./app-DR5J2daJ.js";const r={},k=p(`<h2 id="audit-的概念" tabindex="-1"><a class="header-anchor" href="#audit-的概念"><span>Audit 的概念</span></a></h2><p>审计（Audit)用于监视用户所执行的数据库操作，审计记录可存在数据字典表（称为审计记录:存储在 system 表空间中的<code>SYS.AUD$</code>表中，可通过视图 <code>dba_audit_trail</code> 查看）或操作系统审计记录中(默认位置为<code>$ORACLE_BASE/admin/$ORACLE_SID/adump/</code>)。Oracle Audit 包含强制性审计、标准审计（Standard Auditing）、基于值的审计（Value-Base Auditing）、细粒度审计（Fine-Grained Auditing）、SYSDBA（和 SYSOPER）审计。</p><ul><li>强制性审计：不管其它审计选项或参数如何设置，所有 OracleDB 都会审计特定的操作。由于数据库需要记录诸如授权用户连接等数据库活动，所以存在强制性审计日志。</li><li>标准数据库审计：通过使用 AUDIT_TRAIL 初始化参数在系统级别启用。启用审计之后，选择要审计的对象和权限，并使用 AUDIT 命令设置审计属性。</li><li>基于值审计：扩展了标准数据库审计的功能，不仅会捕获发生的审计事件，还会捕获插入、更新或删除的实际值。基于值审计是通过数据库触发器实施的。</li><li>细粒度审计(FGA)：扩展了标准数据库审计的功能，从而可捕获发出的实际 SQL 语句，而不仅仅是发生事件的情况。</li><li>SYSDBA（和 SYSOPER）审计：将 DBA 与审计者或安全管理员的审计责任分离开，审计者或安全管理员在操作系统审计线索中负责监视 DBA 的活动。</li></ul><div class="hint-container tip"><p class="hint-container-title">参考地址</p><p>https://docs.oracle.com/cd/E25054_01/network.1111/e16543/auditing.htm</p></div><h2 id="开启和关闭审计" tabindex="-1"><a class="header-anchor" href="#开启和关闭审计"><span>开启和关闭审计</span></a></h2><h3 id="安装审计" tabindex="-1"><a class="header-anchor" href="#安装审计"><span>安装审计</span></a></h3><ul><li>判断是否安装审计</li></ul><p>如果做下面查询的时候发现表不存在，说明审计相关的表还没有安装，需要安装。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>aud$<span class="token punctuation">;</span> <span class="token comment">--没有记录返回</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> dba_audit_trail<span class="token punctuation">;</span> <span class="token comment">--没有记录返回</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>安装审计模块</li></ul><p>审计表安装在 SYSTEM 表空间。所以要确保 SYSTEM 表空间又足够的空间存放审计信息。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token variable">@$ORACLE_HOME</span><span class="token operator">/</span>rdbms<span class="token operator">/</span>admin<span class="token operator">/</span>cataudit<span class="token punctuation">.</span><span class="token keyword">sql</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="审计参数" tabindex="-1"><a class="header-anchor" href="#审计参数"><span>审计参数</span></a></h3><ul><li><p>audit_sys_operations 参数</p><ul><li>audit_sys_operations 参数为 false 时，系统只以 os 文件记录 sysdba 身份的登录、开关数据库的操作。</li><li>audit_sys_operations 参数为 true 时，系统以 os 文件记录 sysdba 身份的登录、开关数据库的操作，以及其它辅助的操作。</li></ul></li><li><p>audit_trail 参数</p><ul><li>none：不启用审计功能；</li><li>db：启用审计功能，将审计信息记录在数据库中（sys.aud$），只包含连接信息（LOGON,LOGOFF），但不包含以 sysdba 或者 sysoper 连接的信息（记录在 OS 中）;</li><li>db,extended：将审计信息记录在数据库中，同时包含执行的 SQL 以及绑定变量;</li><li>os：以 XML 的形式将审计信息记录在 OS 中;</li><li>xml：启用审计功能，审计信息写入 xml 格式的操作系统文件中；</li><li>xml,extended：以 XML 的形式将审计信息记录在 OS 中，同时记录执行的 SQL 以及绑定变量.</li></ul></li><li><p>查看是否启用了审计功能</p></li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">show</span> parameter audit_trail<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="启用审计功能" tabindex="-1"><a class="header-anchor" href="#启用审计功能"><span>启用审计功能</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">alter</span> system <span class="token keyword">set</span> audit_trail <span class="token operator">=</span> <span class="token string">&#39;DB_EXTENDED&#39;</span> scope <span class="token operator">=</span> spfile<span class="token punctuation">;</span>
<span class="token keyword">shutdown</span> immediate<span class="token punctuation">;</span>
startup<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="关闭审计功能" tabindex="-1"><a class="header-anchor" href="#关闭审计功能"><span>关闭审计功能</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">alter</span> system <span class="token keyword">set</span> audit_trail <span class="token operator">=</span> <span class="token string">&#39;None&#39;</span> scope <span class="token operator">=</span> spfile<span class="token punctuation">;</span>
<span class="token keyword">shutdown</span> immediate<span class="token punctuation">;</span>
startup<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="相关表和视图" tabindex="-1"><a class="header-anchor" href="#相关表和视图"><span>相关表和视图</span></a></h2><ul><li><p>SYS.AUD$: 存储标准审计记录</p></li><li><p>SYS.FGA_LOG$: 存储细粒度审计记录</p></li><li><p>DBA_STMT_AUDIT_OPTS: 语句级别标准审计的策略，此视图仅在未启用统一审计</p></li><li><p>DBA_PRIV_AUDIT_OPTS: 权限级别标准审计策略，此视图仅在未启用统一审计</p></li><li><p>DBA_OBJ_AUDIT_OPTS: 对象级别标准审计的策略，此视图仅在未启用统一审计</p></li><li><p>DBA_AUDIT_EXISTS: 显示由AUDIT EXIST和AUDIT NOT EXIST产生的Audit Trail条目,此视图仅在未启用统一审计</p></li><li><p>DBA_AUDIT_MGMT_CLEAN_EVENTS: 显示有关审计跟踪清理或清除事件历史的信息,此视图仅适用于传统审计</p></li><li><p>DBA_AUDIT_MGMT_CLEANUP_JOBS: 显示有关配置的审计跟踪清除作业的信息</p></li><li><p>DBA_AUDIT_MGMT_CONFIG_PARAMS: 显示有关 PL/SQL 包使用的当前配置的审计跟踪属性的信息</p></li><li><p>DBA_AUDIT_MGMT_LAST_ARCH_TS: 显示有关为审计跟踪清理或清除设置的最后一个归档时间戳的信息</p></li><li><p>DBA_AUDIT_OBJECT: 对象级别标准审计记录，此视图仅在未启用统一审计</p></li><li><p>DBA_AUDIT_POLICIES: 描述了数据库中所有细粒度的审计策略，此视图仅在未启用统一审计</p></li><li><p>DBA_AUDIT_POLICY_COLUMNS: 描述数据库中所有细粒度的审计策略列，此视图仅在未启用统一审计</p></li><li><p>DBA_AUDIT_SESSION: 登录登出标准审计记录（普通用户，以 SYSDBA 或者 SYSOPER 的用户不记录），此视图仅在未启用统一审计</p></li><li><p>DBA_AUDIT_STATEMENT: 语句级别标准审计记录，此视图仅在未启用统一审计</p></li><li><p>DBA_AUDIT_TRAIL: 显示所有标准审计跟踪条目，显示所有标准审计跟踪条目，此视图仅在未启用统一审计</p></li><li><p>DBA_FGA_AUDIT_TRAIL: 显示所有审计记录，用于细粒度审计，此视图仅在未启用统一审计</p></li><li><p>DBA_COMMON_AUDIT_TRAIL: DBA_AUDIT_TRAIL+DBA_FGA_AUDIT_TRAIL</p></li><li><p>AUDIT_ACTIONS: 审计行为代码</p></li><li><p>V$XML_AUDIT_TRAIL: XML审计格式，包含标准、FGA、强制审计、SYS</p></li></ul><h3 id="oracle-默认审计" tabindex="-1"><a class="header-anchor" href="#oracle-默认审计"><span>Oracle 默认审计</span></a></h3><ul><li><p>默认权限审计</p><ul><li>ALTER ANY PROCEDURE</li><li>CREATE ANY LIBRARY</li><li>DROP ANY TABLE</li><li>ALTER ANY TABLE</li><li>CREATE ANY PROCEDURE</li><li>DROP PROFILE</li><li>ALTER DATABASE</li><li>CREATE ANY TABLE</li><li>DROP USER</li><li>ALTER PROFILE</li><li>CREATE EXTERNAL JOB</li><li>EXEMPT ACCESS POLICY</li><li>ALTER SYSTEM</li><li>CREATE PUBLIC DATABASE LINK</li><li>GRANT ANY OBJECT PRIVILEGE</li><li>ALTER USER</li><li>CREATE SESSION</li><li>GRANT ANY PRIVILEGE</li><li>AUDIT SYSTEM</li><li>CREATE USER</li><li>GRANT ANY ROLE</li><li>CREATE ANY JOB</li><li>DROP ANY PROCEDURE</li></ul></li><li><p>默认语句审计</p><ul><li>ROLE</li><li>SYSTEM AUDIT</li><li>PUBLIC SYNONYM</li><li>DATABASE LINK</li><li>PROFILE</li><li>SYSTEM GRANT</li></ul></li><li><p>启用审计脚本： <code>$ORACLE_HOME/rdbms/admin/secconf.sql</code>，仅修改 audit 配置；</p></li><li><p>禁用审计脚本： <code>$ORACLE_HOME/rdbms/admin/undoaud.sql</code>，会更改 audit 配置和用户密码设置。</p></li></ul><h3 id="审计配置查询" tabindex="-1"><a class="header-anchor" href="#审计配置查询"><span>审计配置查询</span></a></h3><ul><li>查询配置的语句级审计选项</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_STMT_AUDIT_OPTS<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>查询配置的权限级审计选项</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_PRIV_AUDIT_OPTS<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>查询配置的对象级审计选项</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_OBJ_AUDIT_OPTS
    <span class="token keyword">WHERE</span> OWNER <span class="token operator">=</span> <span class="token string">&#39;LAUREL&#39;</span> <span class="token operator">AND</span> OBJECT_NAME <span class="token operator">LIKE</span> <span class="token string">&#39;EMP%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>查询默认对象审计选项</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ALL_DEF_AUDIT_OPTS<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="审计记录查询" tabindex="-1"><a class="header-anchor" href="#审计记录查询"><span>审计记录查询</span></a></h3><ul><li>查询某个时段审计记录</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
    a<span class="token punctuation">.</span>ntimestamp<span class="token comment">#,</span>
    a<span class="token punctuation">.</span>userid<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>userhost<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>terminal<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span><span class="token keyword">action</span><span class="token comment">#,</span>
    aa<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>obj$creator<span class="token punctuation">,</span>
    a<span class="token punctuation">.</span>obj$name<span class="token punctuation">,</span>
    dbms_lob<span class="token punctuation">.</span>substr<span class="token punctuation">(</span>
        a<span class="token punctuation">.</span>sqltext
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> sqltext<span class="token punctuation">,</span>
    dbms_lob<span class="token punctuation">.</span>substr<span class="token punctuation">(</span>
        a<span class="token punctuation">.</span>sqlbind
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> sqlbind
<span class="token keyword">FROM</span>
    sys<span class="token punctuation">.</span>aud$          a<span class="token punctuation">,</span>
    sys<span class="token punctuation">.</span>audit_actions aa
<span class="token keyword">WHERE</span>
    a<span class="token punctuation">.</span><span class="token keyword">action</span><span class="token comment"># = aa.action</span>
    <span class="token operator">AND</span> a<span class="token punctuation">.</span>ntimestamp<span class="token comment"># &gt;= TO_DATE(&#39;20221212&#39;, &#39;yyyymmdd&#39;);</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>查询审计记录</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- The following query lists audit records generated for all objects in the database:</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_AUDIT_OBJECT<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>查询审计会话选项的审计记录</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> USERNAME<span class="token punctuation">,</span> LOGOFF_TIME<span class="token punctuation">,</span> LOGOFF_LREAD<span class="token punctuation">,</span> LOGOFF_PREAD<span class="token punctuation">,</span>
    LOGOFF_LWRITE<span class="token punctuation">,</span> LOGOFF_DLOCK
    <span class="token keyword">FROM</span> DBA_AUDIT_SESSION<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="类型与操作" tabindex="-1"><a class="header-anchor" href="#类型与操作"><span>类型与操作</span></a></h2><h3 id="操作参数" tabindex="-1"><a class="header-anchor" href="#操作参数"><span>操作参数</span></a></h3><ul><li><p>操作是否成功</p><ul><li>（when successful）对执行成功的语句进行审；</li><li>（when not successful）对不成功的语句进行审计；</li><li>（不加）无论成功与否都进行审计。</li></ul></li><li><p>审计记录策略</p><ul><li>会话审计（by session），会话审计是指对某个用户或所有用户的同一语句只审计一次，形成一条审计记录；</li><li>存取审计（by access），存取审计是指对某个用户或所有用户的同一语句每执行一次审计一次，形成多条审计记录。</li></ul></li></ul><h3 id="标准审计" tabindex="-1"><a class="header-anchor" href="#标准审计"><span>标准审计</span></a></h3><ul><li>语句审计（Statement Auditing）：对特定的 SQL 语句进行审计，不指定具体对象；</li><li>权限审计（Privilege Auditing）：对特定的系统权限使用情况进行审计；</li><li>对象审计（Object Auditing）：对特定的模式对象上执行的特定语句进行审计；</li><li>网络审计（Network Auditing）：对网络协议错误与网络层内部错误进行审计。</li></ul><h4 id="语句审计-statement-auditing" tabindex="-1"><a class="header-anchor" href="#语句审计-statement-auditing"><span>语句审计(Statement Auditing)</span></a></h4><p>（1）语句审计是对特定的 SQL 语句进行审计，与具体的对象没有关系。创建语句审计的基本语法为：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>AUDIT
 sql_statement_
shortcut  <span class="token operator">|</span>  <span class="token keyword">ALL</span>  <span class="token operator">|</span>
<span class="token keyword">ALL</span> STATEMENTS
<span class="token punctuation">[</span> <span class="token keyword">BY</span>  user_lists <span class="token punctuation">]</span>  <span class="token operator">|</span>  <span class="token punctuation">[</span> <span class="token operator">IN</span> <span class="token keyword">SESSION</span>  <span class="token keyword">CURRENT</span> <span class="token punctuation">]</span>  <span class="token punctuation">[</span> <span class="token keyword">BY</span>  <span class="token keyword">SESSION</span>  <span class="token operator">|</span>  ACCESS <span class="token punctuation">]</span>  <span class="token punctuation">[</span> WHENEVER  <span class="token punctuation">[</span><span class="token operator">NOT</span> <span class="token punctuation">]</span> SUCCESSFUL<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>参数解释</em>：</p><ul><li>sql_statement_shortcut：被审计的 SQL 语句的快捷方式；</li><li>ALL：审计大部分 SQL 语句，这里不在列出；</li><li>ALL STATEMENT：对最高级别的 SQL 语句进行审计，即对直接执行的 SQL 语句进行审计，而不对包含在 PL/SQL 程序中的 SQL 语句进行审计；</li><li>BY user_lists：指定审计的用户，如果不指定，则审计全部用户；</li><li>IN SESSION CURRENT：只对当前会话进行审计；</li><li>BY SESSION：会话审计，同一个 SQL 语句只审计一次；</li><li>BY ACCESS：存取审计，同一个 SQL 语句执行几次就审计几次；</li><li>WHENEVER SUCCESSFUL：只审计执行成功的 SQL 语句；</li><li>WHENEVER NOT SUCCESS：只审计执行不成功的 SQL 语句；</li></ul><p>（2）如果要取消对某个语句的审计，只需将<code>AUDIT</code>命令改为<code>NOAUDIT</code>命令即可，其语法与创建 AUDIT 相同。 （3）通过数据字典<code>DBA_STMT_AUDIT_OPTS</code>可以了解当前数据库哪些用户进行了语句审计及审计设置信息。</p><p>（4）配置语句级审计示例</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- Auditing all SQL statements for individual users.</span>
<span class="token comment">-- You can use the ALL STATEMENTS clause to audit only the top-level SQL statements. The behavior of this audit option is different from other statement audit options. If the SQL statement is issued from inside a PL/SQL procedure, then the ALL STATEMENTS audit option does not audit it. This audit option does not affect any other AUDIT options that you may have already set.</span>
AUDIT <span class="token keyword">ALL</span> STATEMENTS <span class="token keyword">BY</span> jward<span class="token punctuation">,</span> jsmith <span class="token keyword">BY</span> ACCESS WHENEVER SUCCESSFUL<span class="token punctuation">;</span>

<span class="token comment">-- Auditing all the SQL statement shortcut activities performed by individual users.</span>
AUDIT <span class="token keyword">ALL</span> <span class="token keyword">BY</span> jward <span class="token keyword">BY</span> ACCESS<span class="token punctuation">;</span>

<span class="token comment">-- Auditing all SQL statements for the current session, regardless of user.</span>
<span class="token comment">-- You can use the IN SESSION CURRENT clause for ALL STATEMENTS audit option to audit top-level SQL statements in the lifetime of the user session. You cannot use the IN SESSION CURRENT clause for a specific user. You cannot use the NOAUDIT statement to cancel it, but the auditing lasts only as long as the user session lasts. When the user ends the session, the auditing ends.</span>
AUDIT <span class="token keyword">ALL</span> STATEMENTS <span class="token operator">IN</span> <span class="token keyword">SESSION</span> <span class="token keyword">CURRENT</span> <span class="token keyword">BY</span> ACCESS WHENEVER <span class="token operator">NOT</span> SUCCESSFUL<span class="token punctuation">;</span>

<span class="token comment">-- Auditing login and logoff connections and disconnections.</span>
AUDIT <span class="token keyword">SESSION</span> <span class="token keyword">BY</span> ACCESS<span class="token punctuation">;</span>
AUDIT <span class="token keyword">SESSION</span> <span class="token keyword">BY</span> jward<span class="token punctuation">,</span> jsmith <span class="token keyword">BY</span> ACCESS<span class="token punctuation">;</span>

<span class="token comment">-- Auditing statements that fail because an object does not exist. </span>
<span class="token comment">-- The NOT EXISTS option of the AUDIT statement specifies auditing of all SQL statements that fail because the target object does not exist.</span>
AUDIT <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">;</span>

audit <span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">by</span> <span class="token keyword">session</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）取消语句级审计示例</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- Using NOAUDIT to Remove Session and SQL Statement Auditing</span>
NOAUDIT <span class="token keyword">session</span><span class="token punctuation">;</span>
NOAUDIT <span class="token keyword">session</span> <span class="token keyword">BY</span> preston<span class="token punctuation">,</span> sebastian<span class="token punctuation">;</span>
NOAUDIT <span class="token keyword">DELETE</span> <span class="token keyword">ANY</span> <span class="token keyword">TABLE</span><span class="token punctuation">;</span>
NOAUDIT <span class="token keyword">SELECT</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">INSERT</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span><span class="token punctuation">;</span>

<span class="token comment">-- Using NOAUDIT to Remove ALL STATEMENTS Auditing</span>
NOAUDIT <span class="token keyword">ALL</span> STATEMENTS<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="权限审计-privilege-auditing" tabindex="-1"><a class="header-anchor" href="#权限审计-privilege-auditing"><span>权限审计（Privilege Auditing）</span></a></h4><p>（1）权限审计是对特定的系统权限进行审计，语法为：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>AUDIT
 system_privilege <span class="token operator">|</span>
<span class="token punctuation">[</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token punctuation">]</span>  <span class="token punctuation">[</span> <span class="token keyword">BY</span> user_lists <span class="token punctuation">]</span>  <span class="token operator">|</span>  <span class="token punctuation">[</span> <span class="token operator">IN</span> <span class="token keyword">SESSION</span> <span class="token keyword">CURRENT</span> <span class="token punctuation">]</span>  <span class="token punctuation">[</span> <span class="token keyword">BY</span> <span class="token keyword">SESSION</span> <span class="token operator">|</span> ACCESS <span class="token punctuation">]</span>  <span class="token punctuation">[</span> WHENEVER  <span class="token punctuation">[</span> <span class="token operator">NOT</span> <span class="token punctuation">]</span> SUCCESSFUL<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）如果要了解当前数据库中对哪些用户使用了什么权限审计，可以通过数据字典<code>DBA_PRIV_AUDIT_OPTS</code>来查看。</p><p>（3）配置权限级审计示例</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- Using AUDIT to Configure Privilege Auditing</span>
audit <span class="token keyword">create</span> <span class="token keyword">any</span> <span class="token keyword">table</span> <span class="token keyword">by</span> access<span class="token punctuation">;</span>

<span class="token comment">-- Auditing Unsuccessful Statements and Privileges</span>
AUDIT <span class="token keyword">SELECT</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">INSERT</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span>
      <span class="token keyword">BY</span> ACCESS
      WHENEVER <span class="token operator">NOT</span> SUCCESSFUL<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）取消权限级审计示例</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- The following statement removes all privilege audit options</span>
NOAUDIT <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span>
<span class="token comment">-- Removing the special privileges autdit options</span>
NOAUDIT <span class="token keyword">SELECT</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">INSERT</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span> <span class="token keyword">TABLE</span><span class="token punctuation">,</span> <span class="token keyword">EXECUTE</span> <span class="token keyword">PROCEDURE</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="对象审计" tabindex="-1"><a class="header-anchor" href="#对象审计"><span>对象审计</span></a></h4><p>（1）对象审计是指对特定模式对象的操作进行审计，与用户无关，语法为：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>AUDIT
 sql_operation <span class="token operator">|</span>
<span class="token keyword">ALL</span>  <span class="token keyword">ON</span> <span class="token punctuation">[</span><span class="token keyword">schema</span><span class="token punctuation">.</span><span class="token punctuation">]</span>object <span class="token punctuation">]</span>  <span class="token punctuation">[</span> <span class="token keyword">BY</span> user_lists <span class="token punctuation">]</span>  <span class="token operator">|</span>  <span class="token punctuation">[</span> <span class="token operator">IN</span> <span class="token keyword">SESSION</span> <span class="token keyword">CURRENT</span> <span class="token punctuation">]</span> <span class="token punctuation">[</span> <span class="token keyword">BY</span> <span class="token keyword">SESSION</span> <span class="token operator">|</span> ACCESS <span class="token punctuation">]</span>  <span class="token punctuation">[</span> WHENEVER  <span class="token punctuation">[</span> <span class="token operator">NOT</span> <span class="token punctuation">]</span> SUCCESSFUL<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>说明：</em> sql_operation 指定了特定对象上要审计的 SQL 语句。</p><p>（2）如果要查看当前数据库哪些模式对象进行了对象审计，可以通过查询<code>DBA_OBJ_AUDIT_OPTS</code>获得。</p><p>（3）配置对象级审计示例</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- Configuring Auditing for a Schema Table</span>
AUDIT <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> laurel<span class="token punctuation">.</span>emp <span class="token keyword">BY</span> ACCESS<span class="token punctuation">;</span>
audit <span class="token keyword">all</span> <span class="token keyword">on</span> scott<span class="token punctuation">.</span>dept <span class="token keyword">by</span> <span class="token keyword">session</span><span class="token punctuation">;</span>

<span class="token comment">-- Configuring Auditing for Any New Objects Using the DEFAULT Clause</span>
AUDIT <span class="token keyword">SELECT</span>
     <span class="token keyword">ON</span> <span class="token keyword">DEFAULT</span>
     <span class="token keyword">BY</span> ACCESS
     WHENEVER <span class="token operator">NOT</span> SUCCESSFUL<span class="token punctuation">;</span>

<span class="token comment">-- Auditing the Execution of a Procedure or Function</span>
AUDIT <span class="token keyword">EXECUTE</span> <span class="token keyword">ON</span> sec_mgr<span class="token punctuation">.</span>auth_orders <span class="token keyword">BY</span> ACCESS<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（4）取消对象级审计示例</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- Use the NOAUDIT statement to remove object auditing. The following statements turn off the corresponding auditing options:</span>
NOAUDIT <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> emp<span class="token punctuation">;</span>
NOAUDIT <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span> <span class="token keyword">ON</span> jward<span class="token punctuation">.</span>dept<span class="token punctuation">;</span>

<span class="token comment">-- To remove all object audit options on the emp table, enter the following statement:</span>
NOAUDIT <span class="token keyword">ALL</span> <span class="token keyword">ON</span> emp<span class="token punctuation">;</span>

<span class="token comment">-- To remove all default object audit options, enter the following statement:</span>
NOAUDIT <span class="token keyword">ALL</span> <span class="token keyword">ON</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="网络审计" tabindex="-1"><a class="header-anchor" href="#网络审计"><span>网络审计</span></a></h4><p>（1）网络审计对协议错误与网络层内部错误进行审计，网络审计捕获客户端与服务器通信过程中发生的错误，这些错误由 SQL*NET 网络服务抛出。网络审计的语法为：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>AUDIT NETWORK
<span class="token punctuation">[</span><span class="token keyword">BY</span> <span class="token keyword">SESSION</span> <span class="token operator">|</span> ACCESS<span class="token punctuation">]</span><span class="token punctuation">[</span>WHENEVER <span class="token punctuation">[</span><span class="token operator">NOT</span><span class="token punctuation">]</span> SUCCESSFUL<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="标准审计总结" tabindex="-1"><a class="header-anchor" href="#标准审计总结"><span>标准审计总结</span></a></h4><ol><li>对删除表(drop table)进行审计 由于没有对 drop table 进行单独审计的操作,需要添加 audit table by user(此命令将对 create table ,drop table, truncate table 进行审计)</li><li>对视图的审计:可以单独对视图的 create 进行审计,如果要对 drop 操作进行审计需要对视图加 audit view(该命令包含有 create view,drop view).</li><li>对程序包的审计:可以对包(函数,存储过程等)的 create 进行审计,如果需要对 drop 操作进行审计需要加 audit procedure(该命令对 CREATE FUNCTION, CREATE LIBRARY , CREATE PACKAGE, CREATE PACKAGE BODY, CREATE PROCEDURE, DROP FUNCTION, DROP LIBRARY, DROP PACKAGE, DROP PROCEDURE 进行审计)</li><li>对用户的审计:可以通过 audit user(该命令包含 create user,alter user,drop user)进行审计.</li></ol><h3 id="基于值的审计" tabindex="-1"><a class="header-anchor" href="#基于值的审计"><span>基于值的审计</span></a></h3><p>进行数据库审计时会记录审计对象中发生的插入、更新和删除操作，但是不会捕获更改的实际值。要扩展 数据库审计，可使用基于值的审计，利用数据库触发（事件驱动的 PL/SQL 构造）来捕获更改的值。</p><p>基于值的审计由用户或第三方代码实施。Oracle DB 提供了可用来构建基于值的审计系统的 PL/SQL 构 造。基于值的审计的关键部分是审计触发器，这是一个单纯为了捕获审计信息而构造的 PL/SQL 触发器。</p><p>通过触发器配置基于值的审计示例：</p>`,80),m=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token comment"},"--以下是一个审计触发器的典型示例："),n(`
`),s("span",{class:"token keyword"},"CREATE"),n(),s("span",{class:"token operator"},"OR"),n(),s("span",{class:"token keyword"},"REPLACE"),n(),s("span",{class:"token keyword"},"TRIGGER"),n(" system"),s("span",{class:"token punctuation"},"."),n(`hrsalary_audit
    `),s("span",{class:"token keyword"},"AFTER"),n(),s("span",{class:"token keyword"},"UPDATE"),n(),s("span",{class:"token keyword"},"OF"),n(` salary
    `),s("span",{class:"token keyword"},"ON"),n(" hr"),s("span",{class:"token punctuation"},"."),n("employees REFERENCING NEW "),s("span",{class:"token keyword"},"AS"),n(" NEW OLD "),s("span",{class:"token keyword"},"AS"),n(` OLD
    `),s("span",{class:"token keyword"},"FOR EACH ROW"),n(),s("span",{class:"token keyword"},"BEGIN"),n(`
    `),s("span",{class:"token keyword"},"IF"),n(" :old"),s("span",{class:"token punctuation"},"."),n("salary "),s("span",{class:"token operator"},"!="),n(" :new"),s("span",{class:"token punctuation"},"."),n("salary "),s("span",{class:"token keyword"},"THEN"),n(`
        `),s("span",{class:"token keyword"},"INSERT"),n(),s("span",{class:"token keyword"},"INTO"),n(" system"),s("span",{class:"token punctuation"},"."),n("audit_employeesVALUES "),s("span",{class:"token punctuation"},"("),n("sys_context"),s("span",{class:"token punctuation"},"("),s("span",{class:"token string"},"'userenv'"),s("span",{class:"token punctuation"},","),s("span",{class:"token string"},"'os_user'"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(" sysdate"),s("span",{class:"token punctuation"},","),n(" sys_context"),s("span",{class:"token punctuation"},"("),s("span",{class:"token string"},"'userenv'"),s("span",{class:"token punctuation"},","),s("span",{class:"token string"},"'ip_address'"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(":new"),s("span",{class:"token punctuation"},"."),n("employee_id "),s("span",{class:"token operator"},"||"),s("span",{class:"token string"},"' salary changed from '"),s("span",{class:"token operator"},"||"),n(":old"),s("span",{class:"token punctuation"},"."),n("salary"),s("span",{class:"token operator"},"||"),n(),s("span",{class:"token string"},"' to '"),s("span",{class:"token operator"},"||"),n(":new"),s("span",{class:"token punctuation"},"."),n("salary"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
    `),s("span",{class:"token keyword"},"END"),n(),s("span",{class:"token keyword"},"IF"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),v=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[n("Audit "),s("span",{class:"token keyword"},"Trigger"),n(),s("span",{class:"token keyword"},"to"),n(" Record Before "),s("span",{class:"token operator"},"and"),n(),s("span",{class:"token keyword"},"After"),n(" Changes "),s("span",{class:"token keyword"},"to"),n(" a "),s("span",{class:"token keyword"},"Table"),n(`

`),s("span",{class:"token comment"},"/* 1. Create the following table: */"),n(` 
`),s("span",{class:"token keyword"},"CREATE"),n(),s("span",{class:"token keyword"},"TABLE"),n(" emp_tab "),s("span",{class:"token punctuation"},"("),n(`
   empno               NUMBER`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"4"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   ename               VARCHAR2`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"10"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   job                 VARCHAR2`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"9"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   mgr                 NUMBER`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"4"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   hiredate            `),s("span",{class:"token keyword"},"DATE"),s("span",{class:"token punctuation"},","),n(`
   sal                 NUMBER`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"8"),s("span",{class:"token punctuation"},","),s("span",{class:"token number"},"2"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   deptno              NUMBER`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"2"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`

`),s("span",{class:"token comment"},"/* 2. Create a table to capture the audit data. */"),n(` 
`),s("span",{class:"token keyword"},"CREATE"),n(),s("span",{class:"token keyword"},"TABLE"),n(" emp_audit_tab "),s("span",{class:"token punctuation"},"("),n(`
   oldname             VARCHAR2`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"10"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   oldjob              VARCHAR2`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"9"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   oldsal              NUMBER `),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"8"),s("span",{class:"token punctuation"},","),s("span",{class:"token number"},"2"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   newname             VARCHAR2`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"10"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   newjob              VARCHAR2`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"9"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   newsal              NUMBER`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"8"),s("span",{class:"token punctuation"},","),s("span",{class:"token number"},"2"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   user1               varchar2`),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"10"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},","),n(`
   systemdate          `),s("span",{class:"token keyword"},"TIMESTAMP"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`

`),s("span",{class:"token comment"},`/* 3. Create a trigger to record the old and new values, the author of the change, 
      and when the change took place. */`),n(` 
`),s("span",{class:"token keyword"},"CREATE"),n(),s("span",{class:"token operator"},"OR"),n(),s("span",{class:"token keyword"},"REPLACE"),n(),s("span",{class:"token keyword"},"TRIGGER"),n(` emp_audit_trig
  `),s("span",{class:"token keyword"},"AFTER"),n(),s("span",{class:"token keyword"},"INSERT"),n(),s("span",{class:"token operator"},"OR"),n(),s("span",{class:"token keyword"},"DELETE"),n(),s("span",{class:"token operator"},"OR"),n(),s("span",{class:"token keyword"},"UPDATE"),n(),s("span",{class:"token keyword"},"ON"),n(` emp_tab
  `),s("span",{class:"token keyword"},"FOR EACH ROW"),n(`
`),s("span",{class:"token keyword"},"BEGIN"),n(`
   `),s("span",{class:"token keyword"},"INSERT"),n(),s("span",{class:"token keyword"},"INTO"),n(" emp_audit_tab "),s("span",{class:"token punctuation"},"("),n(`
   oldname`),s("span",{class:"token punctuation"},","),n(" oldjob"),s("span",{class:"token punctuation"},","),n(" oldsal"),s("span",{class:"token punctuation"},","),n(`
   newname`),s("span",{class:"token punctuation"},","),n(" newjob"),s("span",{class:"token punctuation"},","),n(" newsal"),s("span",{class:"token punctuation"},","),n(`
   user1`),s("span",{class:"token punctuation"},","),n(` systemdate
  `),s("span",{class:"token punctuation"},")"),n(`
  `),s("span",{class:"token keyword"},"VALUES"),n(),s("span",{class:"token punctuation"},"("),n(`
    :OLD`),s("span",{class:"token punctuation"},"."),n("ename"),s("span",{class:"token punctuation"},","),n(" :OLD"),s("span",{class:"token punctuation"},"."),n("job"),s("span",{class:"token punctuation"},","),n(" :OLD"),s("span",{class:"token punctuation"},"."),n("sal"),s("span",{class:"token punctuation"},","),n(`
    :NEW`),s("span",{class:"token punctuation"},"."),n("ename"),s("span",{class:"token punctuation"},","),n(" :NEW"),s("span",{class:"token punctuation"},"."),n("job"),s("span",{class:"token punctuation"},","),n(" :NEW"),s("span",{class:"token punctuation"},"."),n("sal"),s("span",{class:"token punctuation"},","),n(`
    `),s("span",{class:"token keyword"},"user"),s("span",{class:"token punctuation"},","),n(` sysdate
  `),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),_=p(`<h3 id="细粒度审计-fga" tabindex="-1"><a class="header-anchor" href="#细粒度审计-fga"><span>细粒度审计（FGA）</span></a></h3><p>细粒度审计(FGA) 扩展了审计功能，可捕获查询或处理数据的实际 SQL 语句。审计记录会被记录在 FGA_LOG$表中。DBMS_FGA 包主要包括 ADD_POLICY，ENABLE_POLICY，DISABLE_POLICY，和 DROP_POLICY 这 4 个存储过程。</p><p>示例：</p><ul><li>创建审计策略</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code>dbms_fga<span class="token punctuation">.</span>add_policy <span class="token punctuation">(</span>
object_schema<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&#39;BANK&#39;</span><span class="token punctuation">,</span>
object_name<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&#39;ACCOUNTS&#39;</span><span class="token punctuation">,</span>
audit_column <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;BALANCE&#39;</span><span class="token punctuation">,</span>
audit_condition <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;BALANCE &gt;= 11000&#39;</span><span class="token punctuation">,</span>
policy_name<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&#39;ACCOUNTS_ACCESS&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>删除审计策略</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">Begin</span>
dbms_fga<span class="token punctuation">.</span>drop_policy <span class="token punctuation">(</span>
object_schema<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&#39;BANK&#39;</span><span class="token punctuation">,</span>
object_name<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&#39;ACCOUNTS&#39;</span><span class="token punctuation">,</span>
policy_name<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token string">&#39;ACCOUNTS_ACCESS&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>启用审计</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">begin</span>
dbms_fga<span class="token punctuation">.</span>enable_policy <span class="token punctuation">(</span>
object_schema <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;BANK&#39;</span><span class="token punctuation">,</span>
object_name <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;ACCOUNTS&#39;</span><span class="token punctuation">,</span>
policy_name <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;ACCOUNTS_ACCESS&#39;</span><span class="token punctuation">,</span>
<span class="token keyword">enable</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">FALSE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>禁用审计</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">begin</span>
dbms_fga<span class="token punctuation">.</span>disable_policy <span class="token punctuation">(</span>
object_schema <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;BANK&#39;</span><span class="token punctuation">,</span>
object_name <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;ACCOUNTS&#39;</span><span class="token punctuation">,</span>
policy_name <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;ACCOUNTS_ACCESS&#39;</span><span class="token punctuation">,</span>
<span class="token keyword">enable</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">FALSE</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,11),b=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"SELECT"),n(),s("span",{class:"token keyword"},"TEXT"),n(),s("span",{class:"token keyword"},"FROM"),n(" DBA_VIEWS D "),s("span",{class:"token keyword"},"WHERE"),n(" D"),s("span",{class:"token punctuation"},"."),n("VIEW_NAME"),s("span",{class:"token operator"},"="),s("span",{class:"token string"},"'DBA_FGA_AUDIT_TRAIL'"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"})])],-1),A=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"SELECT"),n(" D"),s("span",{class:"token punctuation"},"."),n("REFERENCED_OWNER"),s("span",{class:"token punctuation"},","),n(" D"),s("span",{class:"token punctuation"},"."),n("REFERENCED_NAME"),s("span",{class:"token punctuation"},","),n(" D"),s("span",{class:"token punctuation"},"."),n(`REFERENCED_TYPE
`),s("span",{class:"token keyword"},"FROM"),n(` DBA_DEPENDENCIES D
`),s("span",{class:"token keyword"},"WHERE"),n(" D"),s("span",{class:"token punctuation"},"."),n("NAME "),s("span",{class:"token operator"},"="),n(),s("span",{class:"token string"},"'DBA_SQL_PLAN_BASELINES'"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),T=p(`<ul><li>查看生成的审计</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">,</span>DB_USER<span class="token punctuation">,</span>OS_USER<span class="token punctuation">,</span>OBJECT_SCHEMA<span class="token punctuation">,</span>OBJECT_NAME<span class="token punctuation">,</span>SQL_TEXT <span class="token keyword">FROM</span> DBA_FGA_AUDIT_TRAIL<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><ul><li>如何禁用或删除某个用户下的所有细粒度审计？</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
    <span class="token keyword">FOR</span> CUR <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_AUDIT_POLICIES<span class="token punctuation">)</span> <span class="token keyword">LOOP</span>
        <span class="token comment">--禁用</span>
        DBMS_FGA<span class="token punctuation">.</span>DISABLE_POLICY<span class="token punctuation">(</span>CUR<span class="token punctuation">.</span>OBJECT_SCHEMA<span class="token punctuation">,</span>CUR<span class="token punctuation">.</span>OBJECT_NAME<span class="token punctuation">,</span>CUR<span class="token punctuation">.</span>POLICY_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">--删除</span>
        <span class="token comment">--DBMS_FGA.DROP_POLICY(CUR.OBJECT_SCHEMA,CUR.OBJECT_NAME,CUR.POLICY_NAME);</span>
    <span class="token keyword">END</span> <span class="token keyword">LOOP</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="清理-audit-数据" tabindex="-1"><a class="header-anchor" href="#清理-audit-数据"><span>清理 Audit 数据</span></a></h2><p>Audit 的数据主要存储在 sys.aud$ 表中，该表默认位于 system 表空间中，我们根据需求，将该表移到了 sysaux 表空间中。</p><h3 id="自动清理" tabindex="-1"><a class="header-anchor" href="#自动清理"><span>自动清理</span></a></h3><p>（1）查看审计表大小</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">set</span> timing <span class="token keyword">on</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>aud$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）查看 Audit 审计表中记录的最早的时间</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>ntimestamp<span class="token comment">#) from sys.aud$;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>（3）查看审计数据最后归档时间，只有归档的数据才能删除</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> dba_audit_mgmt_last_arch_ts<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>（4）初始化清理Audit的功能，default_cleanup_interval =&gt;168代表清理周期为168(24*7)小时（只需执行一次）。</p><ul><li>验证是否初始化清理审计日志</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SET</span> SERVEROUTPUT <span class="token keyword">ON</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">IF</span>
    DBMS_AUDIT_MGMT<span class="token punctuation">.</span>IS_CLEANUP_INITIALIZED<span class="token punctuation">(</span>DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">)</span>
    <span class="token keyword">THEN</span>
    DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE<span class="token punctuation">(</span><span class="token string">&#39;AUD$ is initialized for cleanup&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">ELSE</span>
    DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE<span class="token punctuation">(</span><span class="token string">&#39;AUD$ is not initialized for cleanup.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>初始化清理审计日志</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
    dbms_audit_mgmt<span class="token punctuation">.</span>init_cleanup<span class="token punctuation">(</span>
        audit_trail_type <span class="token operator">=</span><span class="token operator">&gt;</span> dbms_audit_mgmt<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">,</span>
        default_cleanup_interval <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">7</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>取消初始化</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
DBMS_AUDIT_MGMT<span class="token punctuation">.</span>DEINIT_CLEANUP<span class="token punctuation">(</span>
    AUDIT_TRAIL_TYPE <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>参数说明：</em></p><ul><li>AUDIT_TRAIL_TYPE <ul><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD: 标准审计, AUD$；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FGA_STD: FGA审计, FGA_LOG$；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_DB_STD: 标准审计+FGA；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_OS: 系统审计文件（.aud）；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_XML: XML格式系统审计文件；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FILES: 系统审计文件+XML格式系统审计文件；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_ALL: 所有审计记录,数据库+系统。</li></ul></li></ul><p>（5）设置需要清理的天数，最后一个数字<code>30</code>代表清理 30 天前的数据（归档时间大于等于清除时间）</p>`,23),E=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    dbms_audit_mgmt`),s("span",{class:"token punctuation"},"."),n("set_last_archive_timestamp"),s("span",{class:"token punctuation"},"("),n(`
        audit_trail_type `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" dbms_audit_mgmt"),s("span",{class:"token punctuation"},"."),n("audit_trail_aud_std"),s("span",{class:"token punctuation"},","),n(`
        last_archive_time `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" systimestamp "),s("span",{class:"token operator"},"-"),n(),s("span",{class:"token number"},"30"),n(`
    `),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),D=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("SET_LAST_ARCHIVE_TIMESTAMP"),s("span",{class:"token punctuation"},"("),n(`
    AUDIT_TRAIL_TYPE     `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_UNIFIED"),s("span",{class:"token punctuation"},","),n(`
    LAST_ARCHIVE_TIME    `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  systimestamp "),s("span",{class:"token operator"},"-"),n(),s("span",{class:"token number"},"30"),s("span",{class:"token punctuation"},","),n(`
    RAC_INSTANCE_NUMBER  `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  "),s("span",{class:"token number"},"1"),s("span",{class:"token punctuation"},","),n(`
    CONTAINER            `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("CONTAINER_CURRENT"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),g=p("<p><em>参数说明：</em></p><ul><li>AUDIT_TRAIL_TYPE <ul><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_UNIFIED，设置通用 audit trail；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD：用于传统标准审计文件表<code>AUD$</code>；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FGA_STD：用于传统 fine-grained 审计文件表<code>FGA_LOG$</code>；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_OS：用于传统操作系统审计文件<code>.aud</code>；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_XML：用于传统操作系统 xml 审计文件。</li></ul></li><li>AUDIT_TRAIL_PURGE_INTERVAL：执行清理 Job 的间隔时间（单位：小时）；</li><li>LAST_ARCHIVE_TIME 设置审计文件的时间戳格式（UTC）： YYYY-MM-DD HH:MI:SS.FF；</li><li>RAC_INSTANCE_NUMBER 指定 Oracle RAC 实例节点；</li><li>CONTAINER用于多租环境 <ul><li>DBMS_AUDIT_MGMT.CONTAINER_CURRENT：当前 PDB，只能在当前 PDB 中执行；</li><li>DBMS_AUDIT_MGMT.CONTAINER_ALL：所有 PDB，只能在 root 容器中执行。</li></ul></li></ul><p>（6）创建 Job 调度程序</p><ul><li>创建</li></ul>",4),I=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("CREATE_PURGE_JOB "),s("span",{class:"token punctuation"},"("),n(`
    AUDIT_TRAIL_TYPE            `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_AUD_STD"),s("span",{class:"token punctuation"},","),n(`
    AUDIT_TRAIL_PURGE_INTERVAL  `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token number"},"12"),s("span",{class:"token punctuation"},","),n(`
    AUDIT_TRAIL_PURGE_NAME      `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'Audit_Trail_PJ'"),s("span",{class:"token punctuation"},","),n(`
    USE_LAST_ARCH_TIMESTAMP     `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token boolean"},"TRUE"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),y=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("CREATE_PURGE_JOB "),s("span",{class:"token punctuation"},"("),n(`
    AUDIT_TRAIL_TYPE            `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_AUD_STD"),s("span",{class:"token punctuation"},","),n(`
    AUDIT_TRAIL_PURGE_INTERVAL  `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token number"},"12"),s("span",{class:"token punctuation"},","),n(`
    AUDIT_TRAIL_PURGE_NAME      `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'Audit_Trail_PJ'"),s("span",{class:"token punctuation"},","),n(`
    USE_LAST_ARCH_TIMESTAMP     `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token boolean"},"TRUE"),s("span",{class:"token punctuation"},","),n(`
    CONTAINER                   `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("CONTAINER_CURRENT"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),S=p(`<ul><li>启用</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
    DBMS_AUDIT_MGMT<span class="token punctuation">.</span>SET_PURGE_JOB_STATUS<span class="token punctuation">(</span>
    AUDIT_TRAIL_PURGE_NAME      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;Audit_Trail_PJ&#39;</span><span class="token punctuation">,</span>
    AUDIT_TRAIL_STATUS_VALUE    <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>PURGE_JOB_ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>禁用</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
    DBMS_AUDIT_MGMT<span class="token punctuation">.</span>SET_PURGE_JOB_STATUS<span class="token punctuation">(</span>
    AUDIT_TRAIL_PURGE_NAME      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;Audit_Trail_PJ&#39;</span><span class="token punctuation">,</span>
    AUDIT_TRAIL_STATUS_VALUE    <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>PURGE_JOB_DISABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>删除</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
 DBMS_AUDIT_MGMT<span class="token punctuation">.</span>DROP_PURGE_JOB<span class="token punctuation">(</span>
  AUDIT_TRAIL_PURGE_NAME  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;Audit_Trail_PJ&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（7）清理 Archive Timestamp 设置</p>`,7),U=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
  DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("CLEAR_LAST_ARCHIVE_TIMESTAMP"),s("span",{class:"token punctuation"},"("),n(`
   AUDIT_TRAIL_TYPE     `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_AUD_STD"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),w=p(`<p><em>参数说明：</em></p><ul><li>AUDIT_TRAIL_TYPE <ul><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD: 标准审计, AUD$；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FGA_STD: FGA审计, FGA_LOG$；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_DB_STD: 标准审计+FGA；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_OS: 系统审计文件（.aud）；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_XML: XML格式系统审计文件；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FILES: 系统审计文件+XML格式系统审计文件；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_ALL: 所有审计记录,数据库+系统。</li></ul></li></ul><h3 id="手动清理" tabindex="-1"><a class="header-anchor" href="#手动清理"><span>手动清理</span></a></h3><p>（1）查看审计表大小</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">set</span> timing <span class="token keyword">on</span>
<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>aud$<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）查看 Audit 审计表中记录的最早的时间</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>ntimestamp<span class="token comment">#) from sys.aud$;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>（3）查看审计数据最后归档时间，只有归档的数据才能删除</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> dba_audit_mgmt_last_arch_ts<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>（4）初始化清理Audit的功能，default_cleanup_interval =&gt;168代表清理周期为168(24*7)小时（只需执行一次）。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
    dbms_audit_mgmt<span class="token punctuation">.</span>init_cleanup<span class="token punctuation">(</span>
        audit_trail_type <span class="token operator">=</span><span class="token operator">&gt;</span> dbms_audit_mgmt<span class="token punctuation">.</span>audit_trail_db_std<span class="token punctuation">,</span>
        default_cleanup_interval <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">7</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>参数说明：</em></p><ul><li>AUDIT_TRAIL_TYPE <ul><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD: 标准审计, AUD$；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FGA_STD: FGA审计, FGA_LOG$；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_DB_STD: 标准审计+FGA；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_OS: 系统审计文件（.aud）；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_XML: XML格式系统审计文件；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FILES: 系统审计文件+XML格式系统审计文件；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_ALL: 所有审计记录,数据库+系统。</li></ul></li></ul><p>（5）设置需要清理的天数，最后一个数字<code>30</code>代表清理 30 天前的数据（归档时间大于等于清除时间）</p>`,14),R=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    dbms_audit_mgmt`),s("span",{class:"token punctuation"},"."),n("set_last_archive_timestamp"),s("span",{class:"token punctuation"},"("),n(`
        audit_trail_type `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" dbms_audit_mgmt"),s("span",{class:"token punctuation"},"."),n("audit_trail_aud_std"),s("span",{class:"token punctuation"},","),n(`
        last_archive_time `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" systimestamp "),s("span",{class:"token operator"},"-"),n(),s("span",{class:"token number"},"30"),n(`
    `),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),L=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("SET_LAST_ARCHIVE_TIMESTAMP"),s("span",{class:"token punctuation"},"("),n(`
    AUDIT_TRAIL_TYPE     `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_UNIFIED"),s("span",{class:"token punctuation"},","),n(`
    LAST_ARCHIVE_TIME    `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  systimestamp "),s("span",{class:"token operator"},"-"),n(),s("span",{class:"token number"},"30"),s("span",{class:"token punctuation"},","),n(`
    RAC_INSTANCE_NUMBER  `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  "),s("span",{class:"token number"},"1"),s("span",{class:"token punctuation"},","),n(`
    CONTAINER            `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("CONTAINER_CURRENT"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),h=p("<p><em>参数说明：</em></p><ul><li>AUDIT_TRAIL_TYPE <ul><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_UNIFIED，设置统一audit trail（12c+）；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD：用于传统标准审计文件表<code>AUD$</code>；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_FGA_STD：用于传统 fine-grained 审计文件表<code>FGA_LOG$</code>；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_OS：用于传统操作系统审计文件<code>.aud</code>；</li><li>DBMS_AUDIT_MGMT.AUDIT_TRAIL_XML：用于传统操作系统 xml 审计文件。</li></ul></li><li>AUDIT_TRAIL_PURGE_INTERVAL：执行清理 Job 的间隔时间（单位：小时）；</li><li>LAST_ARCHIVE_TIME 设置审计文件的时间戳格式（UTC）： YYYY-MM-DD HH:MI:SS.FF；</li><li>RAC_INSTANCE_NUMBER 指定 Oracle RAC 实例节点；</li><li>CONTAINER用于多租环境 <ul><li>DBMS_AUDIT_MGMT.CONTAINER_CURRENT：当前 PDB，只能在当前 PDB 中执行；</li><li>DBMS_AUDIT_MGMT.CONTAINER_ALL：所有 PDB，只能在 root 容器中执行。</li></ul></li></ul><p>（6）手动清理审计日志</p>",3),M=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
  DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("CLEAN_AUDIT_TRAIL"),s("span",{class:"token punctuation"},"("),n(`
   AUDIT_TRAIL_TYPE           `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_AUD_STD"),s("span",{class:"token punctuation"},","),n(`
   USE_LAST_ARCH_TIMESTAMP    `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  "),s("span",{class:"token boolean"},"TRUE"),n(),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),N=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
  DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("CLEAN_AUDIT_TRAIL"),s("span",{class:"token punctuation"},"("),n(`
   AUDIT_TRAIL_TYPE           `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_AUD_STD"),s("span",{class:"token punctuation"},","),n(`
   USE_LAST_ARCH_TIMESTAMP    `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  "),s("span",{class:"token boolean"},"TRUE"),s("span",{class:"token punctuation"},","),n(`
   CONTAINER                  `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("CONTAINER_CURRENT "),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),O=s("p",null,"（7）清理 Archive Timestamp 设置",-1),C=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
  DBMS_AUDIT_MGMT`),s("span",{class:"token punctuation"},"."),n("CLEAR_LAST_ARCHIVE_TIMESTAMP"),s("span",{class:"token punctuation"},"("),n(`
   AUDIT_TRAIL_TYPE     `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n("  DBMS_AUDIT_MGMT"),s("span",{class:"token punctuation"},"."),n("AUDIT_TRAIL_AUD_STD"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),B=p(`<h3 id="直接清理" tabindex="-1"><a class="header-anchor" href="#直接清理"><span>直接清理</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 1. Initialize the AUD$ table for cleanup:</span>
<span class="token keyword">PROCEDURE</span> CleanUpAuditTrailMain<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
  <span class="token comment">-- Connect to the database using appropriate login.</span>
  <span class="token keyword">CALL</span> ConnectToDatabase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">-- The login used must have privileges to modify Audit settings. </span>
  <span class="token comment">-- Currently, the DBA will be the authorized user</span>

  DBMS_AUDIT_MGMT<span class="token punctuation">.</span>INIT_CLEANUP<span class="token punctuation">(</span>
   AUDIT_TRAIL_TYPE           <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">,</span>
   DEFAULT_CLEANUP_INTERVAL   <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">12</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span> <span class="token comment">/*PROCEDURE */</span>
<span class="token operator">/</span>
<span class="token comment">-- 2. Optionally, set the batch size:</span>
<span class="token keyword">BEGIN</span>
  DBMS_AUDIT_MGMT<span class="token punctuation">.</span>SET_AUDIT_TRAIL_PROPERTY<span class="token punctuation">(</span>
   AUDIT_TRAIL_TYPE           <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">,</span>
   AUDIT_TRAIL_PROPERTY       <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>DB_DELETE_BATCH_SIZE<span class="token punctuation">,</span>
   AUDIT_TRAIL_PROPERTY_VALUE <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">100000</span> <span class="token comment">/* delete batch size */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span> <span class="token comment">/*PROCEDURE */</span>
<span class="token operator">/</span>
<span class="token comment">-- 3. Set the last archive timestamp:</span>
<span class="token keyword">PROCEDURE</span> SetCleanUpAuditTrail<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">CALL</span> FindLastArchivedTimestamp<span class="token punctuation">(</span>AUD$<span class="token punctuation">)</span><span class="token punctuation">;</span>
  DBMS_AUDIT_MGMT<span class="token punctuation">.</span>SET_LAST_ARCHIVE_TIMESTAMP<span class="token punctuation">(</span>
   AUDIT_TRAIL_TYPE          <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">,</span>
   LAST_ARCHIVE_TIME         <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;20-AUG-2009 00:00:00&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> <span class="token comment">/* PROCEDURE */</span>
<span class="token operator">/</span>
<span class="token comment">-- 4. Run a customized archive procedure to purge the audit trail records:</span>
<span class="token keyword">BEGIN</span>
  <span class="token keyword">CALL</span> MakeAuditSettings<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">LOOP</span> <span class="token punctuation">(</span><span class="token comment">/* How long to loop*/</span><span class="token punctuation">)</span>
    <span class="token comment">-- Invoke function for audit record archival</span>
    <span class="token keyword">CALL</span> DoAuditRecordArchival<span class="token punctuation">(</span>AUD$<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">CALL</span> SetCleanUpAuditTrail<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">IF</span><span class="token punctuation">(</span><span class="token comment">/* Clean up is needed immediately */</span><span class="token punctuation">)</span>
      DBMS_AUDIT_MGMT<span class="token punctuation">.</span>CLEAN_AUDIT_TRAIL<span class="token punctuation">(</span>
       AUDIT_TRAIL_TYPE        <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">,</span>
       USE_LAST_ARCH_TIMESTAMP <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span>
  <span class="token keyword">END</span> <span class="token keyword">LOOP</span> <span class="token comment">/*LOOP*/</span>
<span class="token keyword">END</span><span class="token punctuation">;</span> <span class="token comment">/* PROCEDURE */</span> 
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="自定义清理" tabindex="-1"><a class="header-anchor" href="#自定义清理"><span>自定义清理</span></a></h3><p>（1）创建存储过程：</p>`,4),q=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"create"),n(),s("span",{class:"token operator"},"or"),n(),s("span",{class:"token keyword"},"replace"),n(),s("span",{class:"token keyword"},"procedure"),n(" sp_trunc_aud_log "),s("span",{class:"token operator"},"is"),n(`
`),s("span",{class:"token keyword"},"begin"),n(`
    `),s("span",{class:"token keyword"},"execute"),n(" immediate "),s("span",{class:"token string"},"'truncate table sys.aud$'"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"end"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),G=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"create"),n(),s("span",{class:"token operator"},"or"),n(),s("span",{class:"token keyword"},"replace"),n(),s("span",{class:"token keyword"},"procedure"),n(" purge_aud_trail "),s("span",{class:"token punctuation"},"("),n("days "),s("span",{class:"token operator"},"in"),n(" number"),s("span",{class:"token punctuation"},")"),n(),s("span",{class:"token keyword"},"as"),n(`
    purge_date `),s("span",{class:"token keyword"},"date"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"begin"),n(`
    purge_date :`),s("span",{class:"token operator"},"="),n(" trunc"),s("span",{class:"token punctuation"},"("),n("sysdate"),s("span",{class:"token operator"},"-"),n("days"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
    dbms_system`),s("span",{class:"token punctuation"},"."),n("ksdwrt"),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"2"),s("span",{class:"token punctuation"},","),s("span",{class:"token string"},"'AUDIT: Purging Audit Trail until '"),n(),s("span",{class:"token operator"},"||"),n(`
    purge_date `),s("span",{class:"token operator"},"||"),n(),s("span",{class:"token string"},"' started'"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
    `),s("span",{class:"token keyword"},"delete"),n(),s("span",{class:"token keyword"},"from"),n(" aud$ "),s("span",{class:"token keyword"},"where"),n(" ntimestamp"),s("span",{class:"token comment"},"# < purge_date;"),n(`
    `),s("span",{class:"token keyword"},"commit"),s("span",{class:"token punctuation"},";"),n(`
    dbms_system`),s("span",{class:"token punctuation"},"."),n("ksdwrt"),s("span",{class:"token punctuation"},"("),s("span",{class:"token number"},"2"),s("span",{class:"token punctuation"},","),s("span",{class:"token string"},"'AUDIT: Purging Audit Trail until '"),n(),s("span",{class:"token operator"},"||"),n(`
    purge_date `),s("span",{class:"token operator"},"||"),n(),s("span",{class:"token string"},"' has completed'"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"end"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),P=s("p",null,"（2）创建自动调度 job",-1),f=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    DBMS_SCHEDULER`),s("span",{class:"token punctuation"},"."),n(`CREATE_JOB
    `),s("span",{class:"token punctuation"},"("),n(`
    job_name `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'day_trunc_aud_log'"),s("span",{class:"token punctuation"},","),n(`
    job_type `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'STORED_PROCEDURE'"),s("span",{class:"token punctuation"},","),n(`
    job_action `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'SP_TRUNC_AUD_LOG'"),s("span",{class:"token punctuation"},","),n(`
    start_date `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(" sysdate"),s("span",{class:"token punctuation"},","),n(`
    repeat_interval `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'FREQ=DAILY; BYHOUR=03; BYMINUTE=30;INTERVAL=1'"),s("span",{class:"token punctuation"},","),n(`
    enabled `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token boolean"},"true"),s("span",{class:"token punctuation"},","),n(`
    comments `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'truncate table aud$ every day'"),n(`
    `),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),F=s("div",{class:"language-sql line-numbers-mode","data-ext":"sql","data-title":"sql"},[s("pre",{class:"language-sql"},[s("code",null,[s("span",{class:"token keyword"},"BEGIN"),n(`
    sys`),s("span",{class:"token punctuation"},"."),n("dbms_scheduler"),s("span",{class:"token punctuation"},"."),n("create_job"),s("span",{class:"token punctuation"},"("),n(`
    job_name `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'AUDIT_PURGE'"),s("span",{class:"token punctuation"},","),n(`
    job_type `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'PLSQL_BLOCK'"),s("span",{class:"token punctuation"},","),n(`
    job_action `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'begin purge_aud_trail(31); end;'"),s("span",{class:"token punctuation"},","),n(`
    schedule_name `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'MAINTENANCE_WINDOW_GROUP'"),s("span",{class:"token punctuation"},","),n(`
    job_class `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},`'"DEFAULT_JOB_CLASS"'`),s("span",{class:"token punctuation"},","),n(`
    comments `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token string"},"'Audit Trail Purge'"),s("span",{class:"token punctuation"},","),n(`
    auto_drop `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token boolean"},"FALSE"),s("span",{class:"token punctuation"},","),n(`
    enabled `),s("span",{class:"token operator"},"="),s("span",{class:"token operator"},">"),n(),s("span",{class:"token boolean"},"TRUE"),s("span",{class:"token punctuation"},")"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token keyword"},"END"),s("span",{class:"token punctuation"},";"),n(`
`),s("span",{class:"token operator"},"/"),n(`

`)])]),s("div",{class:"line-numbers","aria-hidden":"true"},[s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"}),s("div",{class:"line-number"})])],-1),x=p(`<h3 id="删除系统中审计文件" tabindex="-1"><a class="header-anchor" href="#删除系统中审计文件"><span>删除系统中审计文件</span></a></h3><p>删除30天前的审计文件</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token function">find</span> <span class="token variable">$ORACLE_BASE</span>/admin/<span class="token variable">$ORACLE_SID</span>/adump/ <span class="token parameter variable">-t</span> f <span class="token parameter variable">-name</span> <span class="token string">&#39;*.aud&#39;</span> <span class="token parameter variable">-mtime</span> +30 <span class="token parameter variable">-exec</span> <span class="token function">rm</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">\\</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h3 id="空间回收" tabindex="-1"><a class="header-anchor" href="#空间回收"><span>空间回收</span></a></h3><p>在清理<code>sys.aud$</code> 表后,表占用的空间的大小并没有发生改变，需要收回空间。（在上面清理表 <code>sys.aud$</code> 后，实际上，数据还在磁盘上，只是数据不受保护了而已，其空间并没有释放，需要将其释放回收）</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">select</span> segment_name<span class="token punctuation">,</span>bytes<span class="token operator">/</span><span class="token number">1024</span><span class="token operator">/</span><span class="token number">1024</span> <span class="token keyword">from</span> dba_segments <span class="token keyword">where</span> segment_name<span class="token operator">=</span><span class="token string">&#39;AUD$&#39;</span>
<span class="token comment">--激活行移动 Table altered.</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> sys<span class="token punctuation">.</span>aud$ <span class="token keyword">enable</span> <span class="token keyword">row</span> movement<span class="token punctuation">;</span>
<span class="token comment">--进行空间回收 Table altered.</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> sys<span class="token punctuation">.</span>aud$ shrink space <span class="token keyword">cascade</span><span class="token punctuation">;</span>
<span class="token comment">--关闭行移动 Table altered.</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> sys<span class="token punctuation">.</span>aud$ <span class="token keyword">disable</span> <span class="token keyword">row</span> movement<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="审计表空间" tabindex="-1"><a class="header-anchor" href="#审计表空间"><span>审计表空间</span></a></h2><p>（1）创建表空间</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLESPACE</span> audtbs
    DATAFILE <span class="token string">&#39;&lt;oracle data path&gt;/aud01.dbf&#39;</span> SIZE <span class="token number">2</span>G
    AUTOEXTEND <span class="token keyword">ON</span> <span class="token keyword">NEXT</span> <span class="token number">8192</span> MAXSIZE UNLIMITED<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（2）查看<code>AUD$</code>,<code>FGA_LOG$</code>表所在表空间</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span>
    table_name<span class="token punctuation">,</span>
    tablespace_name
<span class="token keyword">FROM</span>
    dba_tables
<span class="token keyword">WHERE</span>
    table_name <span class="token operator">IN</span> <span class="token punctuation">(</span> <span class="token string">&#39;AUD$&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;FGA_LOG$&#39;</span> <span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span>
    table_name<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>（3）移动表空间</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">BEGIN</span>
    dbms_audit_mgmt<span class="token punctuation">.</span>set_audit_trail_location<span class="token punctuation">(</span>
        audit_trail_type <span class="token operator">=</span><span class="token operator">&gt;</span> dbms_audit_mgmt<span class="token punctuation">.</span>audit_trail_db_std<span class="token punctuation">,</span>
        audit_trail_location_value <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;AUDTBS&#39;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>参数说明：</em></p>`,14),Y=s("ul",null,[s("li",null,[s("p",null,"AUDIT_TRAIL_TYPE"),s("ul",null,[s("li",null,"DBMS_AUDIT_MGMT.AUDIT_TRAIL_AUD_STD： 标准审计（AUD$）"),s("li",null,"DBMS_AUDIT_MGMT.AUDIT_TRAIL_FGA_STD： 细粒度审计（FGA_LOG$）"),s("li",null,[n("DBMS_AUDIT_MGMT.AUDIT_TRAIL_DB_STD： 标准+细粒度审计（AUD"),s("span",{class:"katex"},[s("span",{class:"katex-mathml"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("semantics",null,[s("mrow",null,[s("mo",null,"+"),s("mi",null,"F"),s("mi",null,"G"),s("msub",null,[s("mi",null,"A"),s("mi",null,"L")]),s("mi",null,"O"),s("mi",null,"G")]),s("annotation",{encoding:"application/x-tex"},"+FGA_LOG")])])]),s("span",{class:"katex-html","aria-hidden":"true"},[s("span",{class:"base"},[s("span",{class:"strut",style:{height:"0.8333em","vertical-align":"-0.15em"}}),s("span",{class:"mord"},"+"),s("span",{class:"mord mathnormal"},"FG"),s("span",{class:"mord"},[s("span",{class:"mord mathnormal"},"A"),s("span",{class:"msupsub"},[s("span",{class:"vlist-t vlist-t2"},[s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.3283em"}},[s("span",{style:{top:"-2.55em","margin-left":"0em","margin-right":"0.05em"}},[s("span",{class:"pstrut",style:{height:"2.7em"}}),s("span",{class:"sizing reset-size6 size3 mtight"},[s("span",{class:"mord mathnormal mtight"},"L")])])]),s("span",{class:"vlist-s"},"​")]),s("span",{class:"vlist-r"},[s("span",{class:"vlist",style:{height:"0.15em"}},[s("span")])])])])]),s("span",{class:"mord mathnormal"},"OG")])])]),n("）")])])]),s("li",null,[s("p",null,"AUDIT_TRAIL_LOCATION_VALUE： 表空间")])],-1),$=p(`<h2 id="数据库审计最佳实践" tabindex="-1"><a class="header-anchor" href="#数据库审计最佳实践"><span>数据库审计最佳实践</span></a></h2><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 查看audit是否开启</span>
<span class="token keyword">show</span> parameter audit_trail<span class="token punctuation">;</span>
<span class="token comment">--开启审计 DB_EXTENDED： 把审计信息写入表并记录sql信息</span>
<span class="token keyword">alter</span> system <span class="token keyword">set</span> audit_trail<span class="token operator">=</span><span class="token string">&#39;DB_EXTENDED&#39;</span> scope<span class="token operator">=</span>both<span class="token punctuation">;</span>

<span class="token comment">-- 查看审计选项</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_STMT_AUDIT_OPTS<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_PRIV_AUDIT_OPTS<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_OBJ_AUDIT_OPTS<span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> ALL_DEF_AUDIT_OPTS<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> ysdba<span class="token punctuation">.</span>his_DBA_STMT_AUDIT_OPTS <span class="token keyword">as</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_STMT_AUDIT_OPTS<span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> ysdba<span class="token punctuation">.</span>his_DBA_PRIV_AUDIT_OPTS <span class="token keyword">as</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_PRIV_AUDIT_OPTS<span class="token punctuation">;</span>


<span class="token comment">---------------------根据需要开启审计内容-----------------------------</span>
<span class="token comment">--- audit </span>
audit <span class="token keyword">all</span> statements <span class="token keyword">by</span> access<span class="token punctuation">;</span>
<span class="token comment">--audit select table by access;</span>
<span class="token comment">--audit select any table by access;</span>
<span class="token comment">--audit insert table by access;</span>
<span class="token comment">--audit insert any table by access;</span>
<span class="token comment">--audit update table by access;</span>
<span class="token comment">--audit update any table by access;</span>
<span class="token comment">--audit delete table by access;</span>
<span class="token comment">--audit delete any table by access;</span>

<span class="token comment">--- noaudit </span>
noaudit <span class="token keyword">all</span> statements<span class="token punctuation">;</span>
<span class="token comment">--noaudit select table;</span>
<span class="token comment">--noaudit select any table;</span>
<span class="token comment">--noaudit insert table;</span>
<span class="token comment">--noaudit insert any table;</span>
<span class="token comment">--noaudit update table;</span>
<span class="token comment">--noaudit update any table;</span>
<span class="token comment">--noaudit delete table;</span>
<span class="token comment">--noaudit delete any table;</span>
<span class="token comment">------------------</span>


<span class="token comment">--------审计记录查询-------------</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> DBA_AUDIT_OBJECT<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> sys<span class="token punctuation">.</span>aud$<span class="token punctuation">;</span>

<span class="token keyword">grant</span> <span class="token keyword">select</span> <span class="token keyword">on</span> sys<span class="token punctuation">.</span>DBA_AUDIT_OBJECT <span class="token keyword">to</span> ysdba <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">view</span> ysdba<span class="token punctuation">.</span>abelit_auditlog <span class="token keyword">as</span> <span class="token keyword">select</span> os_username<span class="token punctuation">,</span>username<span class="token punctuation">,</span>userhost<span class="token punctuation">,</span>terminal<span class="token punctuation">,</span><span class="token keyword">timestamp</span><span class="token punctuation">,</span>owner<span class="token punctuation">,</span>obj_name<span class="token punctuation">,</span>action_name<span class="token punctuation">,</span>sql_text <span class="token keyword">from</span> sys<span class="token punctuation">.</span>DBA_AUDIT_OBJECT<span class="token punctuation">;</span>


<span class="token keyword">create</span> <span class="token keyword">user</span> p_auditlog_ro identified <span class="token keyword">by</span> <span class="token string">&quot;&lt;password&gt;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> role pr_auditlog_ro<span class="token punctuation">;</span>
<span class="token keyword">grant</span> pr_auditlog_ro <span class="token keyword">to</span> p_auditlog_ro<span class="token punctuation">;</span>
<span class="token keyword">grant</span> resource<span class="token punctuation">,</span><span class="token keyword">connect</span> <span class="token keyword">to</span> pr_auditlog_ro<span class="token punctuation">;</span>
<span class="token keyword">grant</span> <span class="token keyword">select</span> <span class="token keyword">on</span> ysdba<span class="token punctuation">.</span>abelit_auditlog <span class="token keyword">to</span> pr_auditlog_ro <span class="token keyword">with</span> <span class="token keyword">grant</span> <span class="token keyword">option</span><span class="token punctuation">;</span>

<span class="token comment">--create view p_auditlog_ro.abelit_auditlog as select os_username,username,userhost,terminal,timestamp,owner,obj_name,action_name,sql_text from ysdba.abelit_auditlog;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> ysdba<span class="token punctuation">.</span>abelit_auditlog<span class="token punctuation">;</span>


<span class="token comment">-- 样例信息</span>
<span class="token comment">-- 数据库地址： 120.24.235.132</span>
<span class="token comment">-- 数据库端口： 1521</span>
<span class="token comment">-- 数据库用户： p_auditlog_ro</span>
<span class="token comment">-- 数据库密码： &lt;password&gt;</span>
<span class="token comment">-- 实例名称： ynmtxdb1</span>
<span class="token comment">-- 查询语句： select * from ysdba.abelit_auditlog;</span>
<span class="token comment">-------------------------------</span>


<span class="token comment">----------审计日志保留策略-----------------</span>
<span class="token keyword">select</span> <span class="token function">min</span><span class="token punctuation">(</span>ntimestamp<span class="token comment">#) from sys.aud$;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> dba_audit_mgmt_last_arch_ts

<span class="token comment">--- 验证是否初始化清理audit任务</span>
<span class="token keyword">SET</span> SERVEROUTPUT <span class="token keyword">ON</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">IF</span>
    DBMS_AUDIT_MGMT<span class="token punctuation">.</span>IS_CLEANUP_INITIALIZED<span class="token punctuation">(</span>DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">)</span>
    <span class="token keyword">THEN</span>
    DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE<span class="token punctuation">(</span><span class="token string">&#39;AUD$ is initialized for cleanup&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">ELSE</span>
    DBMS_OUTPUT<span class="token punctuation">.</span>PUT_LINE<span class="token punctuation">(</span><span class="token string">&#39;AUD$ is not initialized for cleanup.&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span> <span class="token keyword">IF</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>

<span class="token comment">--- 初始化清理任务</span>
<span class="token keyword">BEGIN</span>
    dbms_audit_mgmt<span class="token punctuation">.</span>init_cleanup<span class="token punctuation">(</span>
        audit_trail_type <span class="token operator">=</span><span class="token operator">&gt;</span> dbms_audit_mgmt<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">,</span>
        default_cleanup_interval <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">24</span><span class="token operator">*</span><span class="token number">1</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>

<span class="token comment">-- 设置需要清理的天数</span>
<span class="token keyword">BEGIN</span>
    dbms_audit_mgmt<span class="token punctuation">.</span>set_last_archive_timestamp<span class="token punctuation">(</span>
        audit_trail_type <span class="token operator">=</span><span class="token operator">&gt;</span> dbms_audit_mgmt<span class="token punctuation">.</span>audit_trail_aud_std<span class="token punctuation">,</span>
        last_archive_time <span class="token operator">=</span><span class="token operator">&gt;</span> systimestamp <span class="token operator">-</span> <span class="token number">7</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>

<span class="token comment">-- 创建 Job 调度程序</span>
<span class="token keyword">BEGIN</span>
    DBMS_AUDIT_MGMT<span class="token punctuation">.</span>CREATE_PURGE_JOB <span class="token punctuation">(</span>
    AUDIT_TRAIL_TYPE            <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>AUDIT_TRAIL_AUD_STD<span class="token punctuation">,</span>
    AUDIT_TRAIL_PURGE_INTERVAL  <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">12</span><span class="token punctuation">,</span>
    AUDIT_TRAIL_PURGE_NAME      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;Audit_Trail_PJ&#39;</span><span class="token punctuation">,</span>
    USE_LAST_ARCH_TIMESTAMP     <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>

<span class="token comment">-- 启动 Job 调度程序</span>
<span class="token keyword">BEGIN</span>
    DBMS_AUDIT_MGMT<span class="token punctuation">.</span>SET_PURGE_JOB_STATUS<span class="token punctuation">(</span>
    AUDIT_TRAIL_PURGE_NAME      <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token string">&#39;Audit_Trail_PJ&#39;</span><span class="token punctuation">,</span>
    AUDIT_TRAIL_STATUS_VALUE    <span class="token operator">=</span><span class="token operator">&gt;</span> DBMS_AUDIT_MGMT<span class="token punctuation">.</span>PURGE_JOB_ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token operator">/</span>

<span class="token comment">--------------------------------</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2);function V(H,J){const l=c("CodeTabs");return u(),d("div",null,[k,o(l,{id:"703",data:[{id:"基本示例"},{id:"完整示例"}],active:0},{title0:a(({value:e,isActive:t})=>[n("基本示例")]),title1:a(({value:e,isActive:t})=>[n("完整示例")]),tab0:a(({value:e,isActive:t})=>[m]),tab1:a(({value:e,isActive:t})=>[v]),_:1}),_,o(l,{id:"752",data:[{id:"查询视图"},{id:"查询引用列"}],active:0},{title0:a(({value:e,isActive:t})=>[n("查询视图")]),title1:a(({value:e,isActive:t})=>[n("查询引用列")]),tab0:a(({value:e,isActive:t})=>[b]),tab1:a(({value:e,isActive:t})=>[A]),_:1}),T,o(l,{id:"874",data:[{id:"11g"},{id:"12c"}],active:0},{title0:a(({value:e,isActive:t})=>[n("11g")]),title1:a(({value:e,isActive:t})=>[n("12c")]),tab0:a(({value:e,isActive:t})=>[E]),tab1:a(({value:e,isActive:t})=>[D]),_:1}),g,o(l,{id:"961",data:[{id:"11g-"},{id:"12c+"}],active:0},{title0:a(({value:e,isActive:t})=>[n("11g-")]),title1:a(({value:e,isActive:t})=>[n("12c+")]),tab0:a(({value:e,isActive:t})=>[I]),tab1:a(({value:e,isActive:t})=>[y]),_:1}),S,o(l,{id:"996",data:[{id:"11g-"}],active:0},{title0:a(({value:e,isActive:t})=>[n("11g-")]),tab0:a(({value:e,isActive:t})=>[U]),_:1}),w,o(l,{id:"1121",data:[{id:"11g"},{id:"12c"}],active:0},{title0:a(({value:e,isActive:t})=>[n("11g")]),title1:a(({value:e,isActive:t})=>[n("12c")]),tab0:a(({value:e,isActive:t})=>[R]),tab1:a(({value:e,isActive:t})=>[L]),_:1}),h,o(l,{id:"1201",data:[{id:"11g-"},{id:"12c+"}],active:0},{title0:a(({value:e,isActive:t})=>[n("11g-")]),title1:a(({value:e,isActive:t})=>[n("12c+")]),tab0:a(({value:e,isActive:t})=>[M]),tab1:a(({value:e,isActive:t})=>[N]),_:1}),O,o(l,{id:"1212",data:[{id:"11g-"}],active:0},{title0:a(({value:e,isActive:t})=>[n("11g-")]),tab0:a(({value:e,isActive:t})=>[C]),_:1}),B,o(l,{id:"1231",data:[{id:"truncate"},{id:"delete"}],active:0},{title0:a(({value:e,isActive:t})=>[n("truncate")]),title1:a(({value:e,isActive:t})=>[n("delete")]),tab0:a(({value:e,isActive:t})=>[q]),tab1:a(({value:e,isActive:t})=>[G]),_:1}),P,o(l,{id:"1242",data:[{id:"truncate"},{id:"delete"}],active:0},{title0:a(({value:e,isActive:t})=>[n("truncate")]),title1:a(({value:e,isActive:t})=>[n("delete")]),tab0:a(({value:e,isActive:t})=>[f]),tab1:a(({value:e,isActive:t})=>[F]),_:1}),x,Y,$])}const X=i(r,[["render",V],["__file","audit.html.vue"]]),W=JSON.parse('{"path":"/guide/database/oracle/audit.html","title":"数据库审计","lang":"zh-CN","frontmatter":{"title":"数据库审计","description":"Audit 的概念 审计（Audit)用于监视用户所执行的数据库操作，审计记录可存在数据字典表（称为审计记录:存储在 system 表空间中的SYS.AUD$表中，可通过视图 dba_audit_trail 查看）或操作系统审计记录中(默认位置为$ORACLE_BASE/admin/$ORACLE_SID/adump/)。Oracle Audit 包含...","head":[["meta",{"property":"og:url","content":"https://github.com/abelit/abelit-datapeacock.git/guide/database/oracle/audit.html"}],["meta",{"property":"og:site_name","content":"数之雀"}],["meta",{"property":"og:title","content":"数据库审计"}],["meta",{"property":"og:description","content":"Audit 的概念 审计（Audit)用于监视用户所执行的数据库操作，审计记录可存在数据字典表（称为审计记录:存储在 system 表空间中的SYS.AUD$表中，可通过视图 dba_audit_trail 查看）或操作系统审计记录中(默认位置为$ORACLE_BASE/admin/$ORACLE_SID/adump/)。Oracle Audit 包含..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-05-11T14:06:18.000Z"}],["meta",{"property":"article:author","content":"Abelit"}],["meta",{"property":"article:modified_time","content":"2024-05-11T14:06:18.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"数据库审计\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-05-11T14:06:18.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Abelit\\",\\"url\\":\\"https://github.com/abelit\\"}]}"]]},"headers":[{"level":2,"title":"Audit 的概念","slug":"audit-的概念","link":"#audit-的概念","children":[]},{"level":2,"title":"开启和关闭审计","slug":"开启和关闭审计","link":"#开启和关闭审计","children":[{"level":3,"title":"安装审计","slug":"安装审计","link":"#安装审计","children":[]},{"level":3,"title":"审计参数","slug":"审计参数","link":"#审计参数","children":[]},{"level":3,"title":"启用审计功能","slug":"启用审计功能","link":"#启用审计功能","children":[]},{"level":3,"title":"关闭审计功能","slug":"关闭审计功能","link":"#关闭审计功能","children":[]}]},{"level":2,"title":"相关表和视图","slug":"相关表和视图","link":"#相关表和视图","children":[{"level":3,"title":"Oracle 默认审计","slug":"oracle-默认审计","link":"#oracle-默认审计","children":[]},{"level":3,"title":"审计配置查询","slug":"审计配置查询","link":"#审计配置查询","children":[]},{"level":3,"title":"审计记录查询","slug":"审计记录查询","link":"#审计记录查询","children":[]}]},{"level":2,"title":"类型与操作","slug":"类型与操作","link":"#类型与操作","children":[{"level":3,"title":"操作参数","slug":"操作参数","link":"#操作参数","children":[]},{"level":3,"title":"标准审计","slug":"标准审计","link":"#标准审计","children":[]},{"level":3,"title":"基于值的审计","slug":"基于值的审计","link":"#基于值的审计","children":[]},{"level":3,"title":"细粒度审计（FGA）","slug":"细粒度审计-fga","link":"#细粒度审计-fga","children":[]}]},{"level":2,"title":"清理 Audit 数据","slug":"清理-audit-数据","link":"#清理-audit-数据","children":[{"level":3,"title":"自动清理","slug":"自动清理","link":"#自动清理","children":[]},{"level":3,"title":"手动清理","slug":"手动清理","link":"#手动清理","children":[]},{"level":3,"title":"直接清理","slug":"直接清理","link":"#直接清理","children":[]},{"level":3,"title":"自定义清理","slug":"自定义清理","link":"#自定义清理","children":[]},{"level":3,"title":"删除系统中审计文件","slug":"删除系统中审计文件","link":"#删除系统中审计文件","children":[]},{"level":3,"title":"空间回收","slug":"空间回收","link":"#空间回收","children":[]}]},{"level":2,"title":"审计表空间","slug":"审计表空间","link":"#审计表空间","children":[]},{"level":2,"title":"数据库审计最佳实践","slug":"数据库审计最佳实践","link":"#数据库审计最佳实践","children":[]}],"git":{"createdTime":1715436378000,"updatedTime":1715436378000,"contributors":[{"name":"ableit","email":"ychenid@live.com","commits":1}]},"readingTime":{"minutes":19.49,"words":5848},"filePathRelative":"guide/database/oracle/audit.md","localizedDate":"2024年5月11日","autoDesc":true,"excerpt":"<h2>Audit 的概念</h2>\\n<p>审计（Audit)用于监视用户所执行的数据库操作，审计记录可存在数据字典表（称为审计记录:存储在 system 表空间中的<code>SYS.AUD$</code>表中，可通过视图 <code>dba_audit_trail</code> 查看）或操作系统审计记录中(默认位置为<code>$ORACLE_BASE/admin/$ORACLE_SID/adump/</code>)。Oracle Audit 包含强制性审计、标准审计（Standard Auditing）、基于值的审计（Value-Base Auditing）、细粒度审计（Fine-Grained Auditing）、SYSDBA（和 SYSOPER）审计。</p>"}');export{X as comp,W as data};
